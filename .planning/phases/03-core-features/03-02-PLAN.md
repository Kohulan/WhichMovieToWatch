---
phase: 03-core-features
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/discovery/DiscoveryPage.tsx
  - src/components/onboarding/OnboardingWizard.tsx
  - src/components/onboarding/ProviderSelector.tsx
  - src/components/onboarding/GenreSelector.tsx
  - src/stores/discoveryStore.ts
  - src/stores/preferencesStore.ts
  - src/pages/DiscoverPage.tsx
autonomous: true
requirements:
  - DISC-01
  - DISC-02
  - DISC-03
  - DISC-04
  - INTR-01
  - INTR-02
  - INTR-03
  - INTR-04
  - PREF-01
  - PREF-02
  - PREF-03
  - PREF-04
  - PREF-05

must_haves:
  truths:
    - "User can discover a random movie filtered by genre, provider, and rating >=6.0"
    - "Discovery retries with progressively relaxed filters up to 5 relaxation steps"
    - "User can tap Next to get another random movie recommendation"
    - "Deep link ?movie=123 loads that specific movie on the discovery screen"
    - "Love action saves movie, updates taste profile, and shows similar recommendations"
    - "Watched action marks movie as seen and it never appears again"
    - "Not Interested action skips movie and reduces preference for similar genres"
    - "First-visit users see a multi-step onboarding wizard (providers then genres)"
    - "User can skip onboarding and preferences still have sensible defaults"
    - "Selected providers and genres persist in localStorage and apply to all discovery"
  artifacts:
    - path: "src/components/discovery/DiscoveryPage.tsx"
      provides: "Main discovery screen with MovieHero + actions + similar movies"
      contains: "DiscoveryPage"
    - path: "src/components/onboarding/OnboardingWizard.tsx"
      provides: "Multi-step first-visit preference wizard"
      contains: "OnboardingWizard"
    - path: "src/components/onboarding/ProviderSelector.tsx"
      provides: "Provider logo grid with toggle selection"
      contains: "ProviderSelector"
    - path: "src/components/onboarding/GenreSelector.tsx"
      provides: "Genre clay pill chip selection with Any option"
      contains: "GenreSelector"
    - path: "src/pages/DiscoverPage.tsx"
      provides: "Route-level page composing DiscoveryPage + OnboardingWizard"
      contains: "DiscoverPage"
  key_links:
    - from: "src/components/discovery/DiscoveryPage.tsx"
      to: "useRandomMovie hook"
      via: "calls discover() to fetch and display movie"
      pattern: "useRandomMovie|discover\\("
    - from: "src/components/discovery/DiscoveryPage.tsx"
      to: "useDeepLink hook"
      via: "reads deepLinkMovieId on mount to load specific movie"
      pattern: "useDeepLink|deepLinkMovieId"
    - from: "src/components/discovery/DiscoveryPage.tsx"
      to: "useSimilarMovies hook"
      via: "fetches similar movies when user taps Love"
      pattern: "useSimilarMovies"
    - from: "src/components/onboarding/OnboardingWizard.tsx"
      to: "preferencesStore"
      via: "persists selected providers and genres"
      pattern: "setMyServices|setPreferredGenre|setPreferredProvider"
---

<objective>
Build the core discovery experience: the main screen where users discover random movies one-at-a-time in a cinematic hero view, interact with them (Love, Watched, Not Interested, Next), and the first-visit onboarding wizard for setting provider and genre preferences.

Purpose: This is the primary user journey. Without the discovery flow, the app has no core loop. The onboarding wizard ensures users get personalized recommendations from the first interaction.

Output: DiscoveryPage component, OnboardingWizard with ProviderSelector and GenreSelector, DiscoverPage route page, and store fixes for proper TMDBMovieDetails typing.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-features/03-01-SUMMARY.md
@src/types/movie.ts
@src/types/provider.ts
@src/stores/discoveryStore.ts
@src/stores/preferencesStore.ts
@src/stores/movieHistoryStore.ts
@src/hooks/useRandomMovie.ts
@src/hooks/useMovieDetails.ts
@src/hooks/useOmdbRatings.ts
@src/hooks/useWatchProviders.ts
@src/lib/genre-map.ts
@src/services/tmdb/discover.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix discoveryStore typing + build DiscoveryPage with full movie display and interactions</name>
  <files>
    src/stores/discoveryStore.ts
    src/components/discovery/DiscoveryPage.tsx
    src/pages/DiscoverPage.tsx
  </files>
  <action>
    **Store fix** — The discoveryStore uses `Record<string, unknown>` as a placeholder for TMDBMovieDetails. Fix this:
    1. In `src/stores/discoveryStore.ts`: Replace `type TMDBMovieDetails = Record<string, unknown>` with `import type { TMDBMovieDetails } from '@/types/movie'`. Update the `currentMovie` type to `TMDBMovieDetails | null`. This also means `useRandomMovie.ts` no longer needs the `as Record<string, unknown>` cast — remove it.

    **DiscoveryPage** (`src/components/discovery/DiscoveryPage.tsx`):
    - Composes: MovieHero, RatingBadges, ProviderSection, MovieActions, TrailerLink (all from Plan 01).
    - Uses hooks: `useRandomMovie` (discover), `useMovieDetails` (deep link), `useOmdbRatings` (ratings), `useWatchProviders` (providers), `useSimilarMovies` (love action), `useDeepLink` (URL param).
    - **Mount behavior**:
      1. Check `useDeepLink` for `deepLinkMovieId`. If present, fetch that movie via `useMovieDetails(deepLinkMovieId)` and display it (DISC-04).
      2. If no deep link, call `discover()` from `useRandomMovie` on first render.
    - **Display**: When `currentMovie` exists in discoveryStore:
      - Render MovieHero with full movie data.
      - Below hero: RatingBadges (pass TMDB vote_average + OMDB ratings from useOmdbRatings using movie's imdb_id).
      - Below ratings: ProviderSection (pass providers from useWatchProviders using movie id). Include `findMovieLink` as TMDB movie URL for cross-region search (DISP-05).
      - Below providers: TrailerLink (pass movie.videos).
      - Below trailer: MovieActions with handlers.
    - **Loading state**: When `isLoading`, show ClaySkeletonCard.
    - **Error state**: When `error`, show error message in ClayCard with retry MetalButton.
    - **Action handlers**:
      - `handleNext`: Calls `discover()` from useRandomMovie.
      - `handleLove`: Calls `movieHistoryStore.markLoved(movieId)`. Calls `preferencesStore.recordLove(genres, decade, directorId)` for taste profile (INTR-04). Shows toast "Added to favorites!". Triggers `useSimilarMovies` to show similar recommendations below the current movie as a horizontal scroll row of small MovieCard-like items (poster + title). Tapping a similar movie loads it as the current movie (INTR-01).
      - Watched/Not Interested handlers are in MovieActions component already (from Plan 01), they call `handleNext` after store updates.
    - **Similar movies section**: When `useSimilarMovies` returns movies (after Love), render a "You might also like" section with horizontally scrollable ClayCard thumbnails (poster w185 + title + year). Clicking one sets it as `discoveryStore.setCurrentMovie` after fetching full details.
    - **Accessibility**: Use ScreenReaderAnnouncer to announce movie title when a new movie is displayed (A11Y-04).

    **DiscoverPage** (`src/pages/DiscoverPage.tsx`):
    - Thin route-level wrapper that renders `<DiscoveryPage />` + conditionally renders `<OnboardingWizard />` if user has never set preferences.
    - Check: `usePreferencesStore.getState().myServices.length === 0 && usePreferencesStore.getState().preferredGenre === null` as "never onboarded" signal.
    - Store a local state `showOnboarding` initialized from this check. OnboardingWizard's `onComplete` sets `showOnboarding = false`.
    - Renders `<DiscoveryPage />` as the main content area.
  </action>
  <verify>
    - `npm run build` succeeds with no TypeScript errors
    - `grep -r "TMDBMovieDetails" src/stores/discoveryStore.ts` shows import from @/types/movie
    - `grep -r "useRandomMovie\|useDeepLink\|useSimilarMovies" src/components/discovery/DiscoveryPage.tsx` confirms hook usage
    - `grep -r "DiscoveryPage\|OnboardingWizard" src/pages/DiscoverPage.tsx` confirms component composition
  </verify>
  <done>
    discoveryStore uses proper TMDBMovieDetails type. DiscoveryPage renders cinematic movie hero with ratings, providers, trailer, and action buttons. Deep linking loads specific movie by ID. Love action shows similar movies. Loading and error states handled. DiscoverPage wraps discovery with onboarding gate.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build multi-step onboarding wizard with provider and genre selection</name>
  <files>
    src/components/onboarding/OnboardingWizard.tsx
    src/components/onboarding/ProviderSelector.tsx
    src/components/onboarding/GenreSelector.tsx
  </files>
  <action>
    Per user decision: "Multi-step wizard — Step 1: Pick providers, Step 2: Pick genres, Done."
    Per user decision: "Provider selection as logo grid with toggle."
    Per user decision: "Genre selection as clay pill chips with 'Any' option at the top."
    Per user decision: "Clean claymorphism style for wizard."
    Claude's discretion: "Skip preferences behavior" — when user clicks Skip, close the wizard, leave preferences at defaults (null genre = any, empty myServices = no filtering). This provides the broadest possible discovery without any filters.

    1. **OnboardingWizard** (`src/components/onboarding/OnboardingWizard.tsx`):
       - Renders inside ClayModal (from ui library) with `isOpen` controlled by parent.
       - Props: `isOpen: boolean`, `onComplete: () => void`.
       - Two steps tracked via local state `step: 1 | 2`.
       - Progress indicator: two dots at top, filled dot = current step.
       - Step 1: `<ProviderSelector />` with heading "Choose Your Streaming Services" and subtext "We'll find movies on your platforms".
       - Step 2: `<GenreSelector />` with heading "What genres do you enjoy?" and subtext "Select your favorites or choose Any".
       - Navigation: "Next" MetalButton to advance from step 1 to 2. "Get Started" MetalButton on step 2 to complete.
       - "Skip" text button (ghost variant) on every step that calls `onComplete()` without saving (PREF-02).
       - On "Get Started": persist selections via `preferencesStore.setMyServices(selectedIds)` and `preferencesStore.setPreferredGenre(selectedGenre)` (PREF-05), then call `onComplete()`.

    2. **ProviderSelector** (`src/components/onboarding/ProviderSelector.tsx`):
       - Uses `useRegionProviders` hook to fetch available providers for user's region.
       - Renders a grid of provider logo buttons (grid-cols-3 on mobile, grid-cols-4 on tablet+).
       - Each provider: 48x48 logo image (from getProviderLogoUrl) in a rounded-lg container.
       - Selected state: highlighted ring (ring-2 ring-accent), unselected: dimmed opacity-50.
       - Toggle on click via local `selectedIds: Set<number>` state.
       - Props: `selectedIds: number[]`, `onSelectionChange: (ids: number[]) => void`.
       - Top 8 providers shown prominently (PREF-03): Netflix (8), Disney+ (337), Amazon Prime (9/119), Hulu (15), HBO Max (384), Apple TV+ (350), Paramount+ (531), Peacock (386). If not available in region, still show grayed out.
       - "Show all" expandable section for remaining providers.
       - Loading state: skeleton grid while fetching.

    3. **GenreSelector** (`src/components/onboarding/GenreSelector.tsx`):
       - Uses `getAllGenres()` from `@/lib/genre-map` for the genre list.
       - Props: `selectedGenre: string | null`, `onGenreChange: (genreId: string | null) => void`.
       - "Any" option as first item — when selected, sets `selectedGenre = null` (PREF-04).
       - Each genre rendered as a ClayBadge (variant "muted" when unselected, "accent" when selected).
       - Flex-wrap layout with gap-2.
       - Single-select: tapping a genre deselects the previous one (or deselects if tapping the already-selected one, reverting to "Any").
  </action>
  <verify>
    - `npm run build` succeeds with no TypeScript errors
    - `grep -r "ClayModal" src/components/onboarding/OnboardingWizard.tsx` confirms clay modal usage
    - `grep -r "useRegionProviders" src/components/onboarding/ProviderSelector.tsx` confirms hook usage
    - `grep -r "getAllGenres" src/components/onboarding/GenreSelector.tsx` confirms genre map usage
    - `grep -r "setMyServices\|setPreferredGenre" src/components/onboarding/OnboardingWizard.tsx` confirms store persistence
  </verify>
  <done>
    OnboardingWizard shows 2-step flow in ClayModal with progress dots. ProviderSelector renders logo grid with toggle and shows top 8 providers prominently. GenreSelector shows clay pill chips with "Any" option. Skip closes without saving. Complete persists selections to preferencesStore. Preferences apply to all subsequent discovery queries.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero errors
- discoveryStore imports TMDBMovieDetails properly (no more Record<string, unknown>)
- DiscoveryPage renders movie hero with all sub-components
- Deep link ?movie=123 in URL hash loads that movie
- Love/Watched/Not Interested/Next buttons call correct store methods
- OnboardingWizard renders on first visit, can be skipped
- Provider and genre selections persist in localStorage under 'wmtw-preferences'
</verification>

<success_criteria>
- User can discover random movies with smart filtering and retry with relaxed filters
- User can interact with movies (Love shows similar, Watched/Not Interested never show again)
- First-visit onboarding wizard collects provider and genre preferences
- Deep linking works via ?movie=ID URL parameter
- All preferences persist across page refresh
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-features/03-02-SUMMARY.md`
</output>
