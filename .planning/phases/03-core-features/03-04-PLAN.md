---
phase: 03-core-features
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/trending/TrendingPage.tsx
  - src/components/dinner-time/DinnerTimePage.tsx
  - src/components/dinner-time/ServiceBranding.tsx
  - src/components/free-movies/FreeMoviesPage.tsx
  - src/hooks/useFreeMovies.ts
  - src/hooks/useDinnerTime.ts
  - src/stores/movieHistoryStore.ts
  - src/pages/TrendingPage.tsx
  - src/pages/DinnerTimePage.tsx
  - src/pages/FreeMoviesPage.tsx
autonomous: true
requirements:
  - TRND-01
  - TRND-02
  - TRND-03
  - TRND-04
  - DINR-01
  - DINR-02
  - DINR-03
  - DINR-04
  - FREE-01
  - FREE-02
  - FREE-03
  - FREE-04

must_haves:
  truths:
    - "Trending shows region-aware Now Playing movies in a horizontal scroll row"
    - "Trending auto-refreshes every 30 minutes"
    - "Trending falls back to popular movies if now_playing returns empty"
    - "Tapping a trending movie loads its full details"
    - "Dinner Time finds family-friendly movies on Netflix/Prime/Disney+"
    - "Dinner Time shows a dedicated full-page experience with its own focused UI (not just filtered discovery)"
    - "Dinner Time has a direct Watch on [Service] button linking to the service"
    - "Dinner Time tracks like/dislike preferences"
    - "Free Movies loads random movies from the 2000+ entry movies.txt file"
    - "Free Movies fetches TMDB metadata and OMDB ratings for the selected movie"
    - "Free Movies has Watch on YouTube button and Next Suggestion button"
    - "Free Movies shows a regional availability disclaimer"
  artifacts:
    - path: "src/components/trending/TrendingPage.tsx"
      provides: "Now Playing horizontal scroll with auto-refresh"
      contains: "TrendingPage"
    - path: "src/components/dinner-time/DinnerTimePage.tsx"
      provides: "Family-friendly movie finder with service-specific streaming"
      contains: "DinnerTimePage"
    - path: "src/components/free-movies/FreeMoviesPage.tsx"
      provides: "Free YouTube movies discovery"
      contains: "FreeMoviesPage"
    - path: "src/hooks/useFreeMovies.ts"
      provides: "Parses movies.txt and returns random free movie"
      contains: "useFreeMovies"
    - path: "src/hooks/useDinnerTime.ts"
      provides: "Family-friendly discovery with service-specific filtering"
      contains: "useDinnerTime"
  key_links:
    - from: "src/components/trending/TrendingPage.tsx"
      to: "useTrending hook"
      via: "fetches now_playing movies"
      pattern: "useTrending"
    - from: "src/hooks/useFreeMovies.ts"
      to: "data/movies.txt"
      via: "fetches and parses tab-separated file"
      pattern: "movies\\.txt|fetch.*data"
    - from: "src/components/dinner-time/DinnerTimePage.tsx"
      to: "useDinnerTime hook"
      via: "discovers family-friendly movies with service filter"
      pattern: "useDinnerTime"
    - from: "src/hooks/useDinnerTime.ts"
      to: "tmdb discover service"
      via: "uses /discover/movie with family-friendly filters"
      pattern: "discoverMovie|tmdbFetch"
---

<objective>
Build the three secondary discovery modes: Trending (Now Playing), Dinner Time (family-friendly finder), and Free Movies (YouTube movies). Each is a distinct page/tab reachable via navigation.

Purpose: These modes serve specific use cases beyond random discovery: browsing what's popular in theaters, finding something the whole family can watch tonight, and watching legally free movies on YouTube.

Output: TrendingPage, DinnerTimePage with ServiceBranding, FreeMoviesPage, useFreeMovies hook, useDinnerTime hook, and extended movieHistoryStore.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-features/03-01-SUMMARY.md
@src/types/movie.ts
@src/hooks/useTrending.ts
@src/hooks/useMovieDetails.ts
@src/hooks/useOmdbRatings.ts
@src/stores/movieHistoryStore.ts
@src/services/tmdb/client.ts
@src/services/tmdb/discover.ts
@src/services/tmdb/trending.ts
@data/movies.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build TrendingPage + useDinnerTime hook + useFreeMovies hook + extend movieHistoryStore</name>
  <files>
    src/components/trending/TrendingPage.tsx
    src/hooks/useDinnerTime.ts
    src/hooks/useFreeMovies.ts
    src/stores/movieHistoryStore.ts
    src/pages/TrendingPage.tsx
  </files>
  <action>
    1. **Extend movieHistoryStore** (`src/stores/movieHistoryStore.ts`):
       - Add `dinnerTimeLikes: number[]` and `dinnerTimeDislikes: number[]` arrays for Dinner Time preference tracking (DINR-04).
       - Add actions: `markDinnerLike(movieId: number)`, `markDinnerDislike(movieId: number)`.
       - Add to `partialize` so they persist in localStorage.

    2. **TrendingPage** (`src/components/trending/TrendingPage.tsx`):
       - Uses `useTrending` hook which already handles region-aware now_playing with 30-min auto-refresh and popular fallback (TRND-01, TRND-02, TRND-04).
       - Per user decision: "Trending shows movies in a horizontal scroll row — poster thumbnails in a scrollable strip, tap to expand."
       - Layout:
         - Section heading: "Now Playing" with a refresh icon button that manually calls `refresh()`.
         - Horizontal scroll container: `overflow-x-auto flex gap-4 snap-x snap-mandatory pb-4`.
         - Each movie card (TRND-03): ClayCard with poster (w185), title (truncated 2 lines), year, rating badge (colored). `snap-start` for scroll snapping. Width fixed at 160px.
         - On click: Navigate to `/#/?movie={id}` to load movie in discovery screen with full details.
       - Loading state: Row of ClaySkeletonCard (5 placeholders).
       - Error state: Error message with retry button.
       - Auto-refresh indicator: subtle last-updated timestamp text.

    3. **TrendingPage route wrapper** (`src/pages/TrendingPage.tsx`):
       - Renders `<TrendingPage />` component. Simple route wrapper.

    4. **useDinnerTime** (`src/hooks/useDinnerTime.ts`):
       - Family-friendly discovery hook for Netflix/Prime/Disney+ (DINR-01).
       - Uses `tmdbFetch('/discover/movie', ...)` with these params:
         - `certification_country: 'US'`, `certification.lte: 'PG-13'` (family-friendly).
         - `with_genres: '10751|16|12|35'` (Family, Animation, Adventure, Comedy).
         - `vote_average.gte: 6.0`.
         - `with_watch_providers: providerId` (caller passes Netflix=8, Prime=9, Disney+=337).
         - `watch_region: region` from regionStore.
       - Returns: `{ movie: TMDBMovieDetails | null, isLoading, error, nextMovie: () => void, setService: (id: number) => void, currentService: number }`.
       - `nextMovie`: Fetches another random movie from the discover results, excluding already-shown (uses movieHistoryStore).
       - Fetches full details via `fetchMovieDetails` for the selected movie.
       - Tracks shown movies via movieHistoryStore.

    5. **useFreeMovies** (`src/hooks/useFreeMovies.ts`):
       - Fetches and parses `data/movies.txt` (tab-separated: YouTubeID\tTitle) (FREE-01).
       - **CRITICAL**: Use `import.meta.env.BASE_URL` prefix for the fetch URL to work on GitHub Pages: `fetch(\`${import.meta.env.BASE_URL}data/movies.txt\`)`.
       - Parses lines, skips header row ("YouTube ID\tTitle"), stores in module-level cache (not re-fetched).
       - `getRandomFreeMovie()`: Picks a random entry not in movieHistoryStore's shown set.
       - Returns: `{ youtubeId: string, title: string }`.
       - Hook returns: `{ movie: { youtubeId, title, tmdbDetails?, omdbRatings? } | null, isLoading, nextMovie: () => void }`.
       - After picking a random movie, searches TMDB by title to get metadata (FREE-02). Uses existing `searchMovies` service with the title, takes first result.
       - If TMDB match found, fetches full details via `fetchMovieDetails`.
       - OMDB ratings fetched lazily by the consuming component via useOmdbRatings (not in this hook — that's a component concern).
  </action>
  <verify>
    - `npm run build` succeeds with no TypeScript errors
    - `grep -r "dinnerTimeLikes\|dinnerTimeDislikes" src/stores/movieHistoryStore.ts` confirms new fields
    - `grep -r "useTrending" src/components/trending/TrendingPage.tsx` confirms hook usage
    - `grep -r "certification" src/hooks/useDinnerTime.ts` confirms family-friendly filter
    - `grep -r "import.meta.env.BASE_URL" src/hooks/useFreeMovies.ts` confirms correct fetch path
    - `grep -r "movies.txt" src/hooks/useFreeMovies.ts` confirms file parsing
  </verify>
  <done>
    movieHistoryStore extended with dinner time like/dislike tracking. TrendingPage renders horizontal scroll of now-playing movies with auto-refresh and popular fallback. useDinnerTime discovers family-friendly movies on Netflix/Prime/Disney+ with PG-13 certification filter. useFreeMovies parses movies.txt and picks random free YouTube movies with TMDB metadata lookup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build DinnerTimePage and FreeMoviesPage with full UI</name>
  <files>
    src/components/dinner-time/DinnerTimePage.tsx
    src/components/dinner-time/ServiceBranding.tsx
    src/components/free-movies/FreeMoviesPage.tsx
    src/pages/DinnerTimePage.tsx
    src/pages/FreeMoviesPage.tsx
  </files>
  <action>
    Per user decision: "Dinner Time is a dedicated focused UI experience — implemented as a full-page tab route (tab bar decision supersedes earlier modal/overlay phrasing; the key intent is 'not just filtered discovery')."
    Per user decision: "Free Movies uses one-at-a-time discovery — same single-movie focus as main discover."

    1. **ServiceBranding** (`src/components/dinner-time/ServiceBranding.tsx`):
       - Props: `serviceId: number`.
       - Maps service IDs to branding: Netflix (8) = red theme + logo, Prime Video (9/119) = blue theme + logo, Disney+ (337) = blue-purple theme + logo.
       - Returns: `{ name: string, color: string, watchUrl: (title: string) => string }`.
         - Netflix watch URL: `https://www.netflix.com/search?q=${encodeURIComponent(title)}` (DINR-03).
         - Prime watch URL: `https://www.amazon.com/s?k=${encodeURIComponent(title)}&i=instant-video`.
         - Disney+ watch URL: `https://www.disneyplus.com/search/${encodeURIComponent(title)}`.
       - Renders a styled service badge with service logo and name.

    2. **DinnerTimePage** (`src/components/dinner-time/DinnerTimePage.tsx`):
       - Dedicated full-page experience (DINR-02).
       - Uses `useDinnerTime` hook.
       - Top: Service selector — three large MetalButton tabs for Netflix, Prime, Disney+. Active service highlighted. Clicking switches `useDinnerTime.setService(id)`.
       - Movie display area (when movie loaded):
         - Movie poster (w342) centered.
         - Title, year, runtime, overview.
         - RatingBadges (from Plan 01) with TMDB rating + OMDB ratings (via useOmdbRatings on movie's imdb_id).
         - GenreBadges.
         - ServiceBranding badge showing which service has it.
         - "Watch on [Service]" MetalButton (primary variant, accent color matching service) wrapped in ExternalLink to the service search URL (DINR-03).
       - Action row:
         - ThumbsUp icon + "Great Pick" — calls `movieHistoryStore.markDinnerLike(movieId)` + shows toast + auto-loads next (DINR-04).
         - ThumbsDown icon + "Not This One" — calls `movieHistoryStore.markDinnerDislike(movieId)` + loads next (DINR-04).
         - SkipForward icon + "Next" — calls `useDinnerTime.nextMovie()`.
       - Loading state: ClaySkeletonCard.
       - Error/empty state: "No family-friendly movies found on [Service] in your region" with suggestion to try another service.
       - Background: Subtle service-branded gradient overlay (e.g., Netflix red tint).

    3. **FreeMoviesPage** (`src/components/free-movies/FreeMoviesPage.tsx`):
       - Same single-movie focus as main discovery (per user decision).
       - Uses `useFreeMovies` hook.
       - When a movie is loaded:
         - Movie poster (from TMDB lookup, w342) centered. If no TMDB match, show placeholder.
         - Title prominently displayed.
         - If TMDB details available: year, runtime, overview, GenreBadges, RatingBadges.
         - "Watch on YouTube" MetalButton (primary, red accent) wrapped in ExternalLink to `https://www.youtube.com/watch?v=${youtubeId}` (FREE-03). YouTube Play icon.
         - "Next Suggestion" MetalButton (secondary) calls `useFreeMovies.nextMovie()` (FREE-03).
       - Regional availability disclaimer: Small text at bottom: "Availability may vary by region. Some movies may not be accessible in all countries." in muted text (FREE-04).
       - Loading state: ClaySkeletonCard with "Finding a free movie..." text.
       - Counter: "Over 2,000 free movies to discover" subtitle.

    4. **Route wrappers** (`src/pages/DinnerTimePage.tsx`, `src/pages/FreeMoviesPage.tsx`):
       - Simple wrappers rendering the respective component.
  </action>
  <verify>
    - `npm run build` succeeds with no TypeScript errors
    - `grep -r "netflix.com/search\|amazon.com/s\|disneyplus.com/search" src/components/dinner-time/ServiceBranding.tsx` confirms service URLs
    - `grep -r "markDinnerLike\|markDinnerDislike" src/components/dinner-time/DinnerTimePage.tsx` confirms like/dislike tracking
    - `grep -r "youtube.com/watch" src/components/free-movies/FreeMoviesPage.tsx` confirms YouTube link
    - `grep -r "Availability may vary" src/components/free-movies/FreeMoviesPage.tsx` confirms disclaimer
  </verify>
  <done>
    DinnerTimePage renders dedicated experience with service selector (Netflix/Prime/Disney+), movie details, Watch on Service button, and like/dislike preference tracking. ServiceBranding maps services to themed URLs and branding. FreeMoviesPage renders one-at-a-time free YouTube movies with TMDB metadata, Watch on YouTube button, Next Suggestion, and regional disclaimer.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero errors
- TrendingPage shows horizontal scroll of movies with auto-refresh
- DinnerTimePage has service selector and Watch on [Service] button
- FreeMoviesPage loads from movies.txt and shows YouTube link
- movieHistoryStore has dinnerTimeLikes/Dislikes persistence
- All pages handle loading, error, and empty states
</verification>

<success_criteria>
- Trending shows region-aware Now Playing with 30-min auto-refresh and popular fallback
- Dinner Time finds PG-13 movies on Netflix/Prime/Disney+ with service-branded UI
- Free Movies loads from 2000+ entries in movies.txt with TMDB enrichment
- All three modes are self-contained pages ready for tab navigation
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-features/03-04-SUMMARY.md`
</output>
