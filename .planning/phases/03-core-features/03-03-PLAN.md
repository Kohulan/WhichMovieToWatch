---
phase: 03-core-features
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/search/SearchModal.tsx
  - src/components/search/SearchBar.tsx
  - src/components/search/SearchResults.tsx
  - src/components/search/AdvancedFilters.tsx
  - src/components/search/FilterPresets.tsx
  - src/components/search/VoiceSearchButton.tsx
  - src/components/shared/DualRangeSlider.tsx
  - src/hooks/useVoiceSearch.ts
  - src/stores/searchStore.ts
autonomous: true
requirements:
  - SRCH-01
  - SRCH-02
  - SRCH-03
  - SRCH-04
  - SRCH-05
  - ADVS-01
  - ADVS-02
  - ADVS-03
  - ADVS-04
  - ADVS-05
  - ADVS-06
  - ADVS-07
  - SECU-02
  - A11Y-03

must_haves:
  truths:
    - "User can search movies via debounced text input (300ms delay)"
    - "Voice search uses Web Speech API with visual microphone feedback"
    - "Search results show poster, title, year, and rating"
    - "Clicking a search result navigates to full movie details on discovery screen"
    - "Search modal closes on outside click and Escape key"
    - "Advanced filters include genre, year range, rating range, runtime, language, and provider"
    - "Sort options (popularity, rating, release date) with ascending/descending toggle"
    - "Quick filter presets load pre-configured filter combinations"
    - "Search results support pagination (load more button)"
    - "Dual-range sliders allow selecting year, rating, and runtime ranges"
    - "Search input is sanitized against XSS"
    - "All interactive elements have visible focus rings for keyboard navigation"
  artifacts:
    - path: "src/components/search/SearchModal.tsx"
      provides: "Search overlay modal with bar + results + filters"
      contains: "SearchModal"
    - path: "src/components/search/SearchBar.tsx"
      provides: "Text input with debounce and voice search button"
      contains: "SearchBar"
    - path: "src/components/search/AdvancedFilters.tsx"
      provides: "Expandable multi-criteria filter panel"
      contains: "AdvancedFilters"
    - path: "src/components/search/FilterPresets.tsx"
      provides: "Quick filter preset buttons"
      contains: "FilterPresets"
    - path: "src/components/shared/DualRangeSlider.tsx"
      provides: "Two-thumb range slider component"
      contains: "DualRangeSlider"
    - path: "src/hooks/useVoiceSearch.ts"
      provides: "Web Speech API integration with feature detection"
      contains: "useVoiceSearch"
    - path: "src/stores/searchStore.ts"
      provides: "Extended search store with advanced filter fields"
      contains: "advancedFilters"
  key_links:
    - from: "src/components/search/SearchBar.tsx"
      to: "useDebouncedValue hook"
      via: "debounces search input before triggering API call"
      pattern: "useDebouncedValue.*300"
    - from: "src/components/search/SearchModal.tsx"
      to: "useSearchMovies hook"
      via: "triggers search and receives results"
      pattern: "useSearchMovies"
    - from: "src/components/search/AdvancedFilters.tsx"
      to: "searchStore advancedFilters"
      via: "reads and writes filter state"
      pattern: "advancedFilters|setAdvancedFilters"
---

<objective>
Build the complete search experience: basic text search with voice input, advanced multi-criteria filtering with dual-range sliders, quick filter presets, paginated results, and a search modal accessible via navbar icon.

Purpose: Search is the second most important discovery mechanism after random recommendations. Advanced search lets power users find exactly what they want across multiple criteria.

Output: SearchModal component with SearchBar, SearchResults, AdvancedFilters, FilterPresets, VoiceSearchButton, DualRangeSlider, useVoiceSearch hook, and extended searchStore.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-features/03-01-SUMMARY.md
@src/types/movie.ts
@src/stores/searchStore.ts
@src/hooks/useSearchMovies.ts
@src/services/tmdb/search.ts
@src/services/tmdb/discover.ts
@src/lib/genre-map.ts
@src/components/ui/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend searchStore + build useVoiceSearch hook + DualRangeSlider + search sanitization</name>
  <files>
    src/stores/searchStore.ts
    src/hooks/useVoiceSearch.ts
    src/components/shared/DualRangeSlider.tsx
  </files>
  <action>
    1. **Extend searchStore** (`src/stores/searchStore.ts`):
       - Replace the inline TMDBMovie type with `import type { TMDBMovie } from '@/types/movie'`.
       - Add `advancedFilters` object to state:
         ```typescript
         advancedFilters: {
           genres: number[];           // TMDB genre IDs
           yearRange: [number, number]; // [1900, currentYear]
           ratingRange: [number, number]; // [0, 10]
           runtimeRange: [number, number]; // [0, 300] minutes
           language: string | null;     // ISO 639-1 code
           providerId: number | null;   // streaming provider
         }
         ```
       - Default values: `genres: [], yearRange: [1900, new Date().getFullYear()], ratingRange: [0, 10], runtimeRange: [0, 300], language: null, providerId: null`.
       - Add actions: `setAdvancedFilters(filters: Partial<AdvancedFilters>)`, `resetAdvancedFilters()`.
       - Add `searchCache: Map<string, TMDBMovie[]>` for repeat query caching (ADVS-05). Actions: `getCachedResults(key: string): TMDBMovie[] | undefined`, `setCachedResults(key: string, results: TMDBMovie[])`.
       - Keep sortBy options: 'popularity.desc', 'popularity.asc', 'vote_average.desc', 'vote_average.asc', 'primary_release_date.desc', 'primary_release_date.asc'.

    2. **useVoiceSearch** (`src/hooks/useVoiceSearch.ts`):
       - Feature detection: Check `window.webkitSpeechRecognition || window.SpeechRecognition` exists.
       - Returns: `{ isSupported: boolean, isListening: boolean, transcript: string, startListening: () => void, stopListening: () => void }`.
       - On `startListening`: Create SpeechRecognition instance, set `lang='en-US'`, `continuous=false`, `interimResults=true`.
       - `onresult`: Update transcript from `event.results[0][0].transcript`.
       - `onend` / `onerror`: Set `isListening = false`.
       - Cleanup: Stop recognition on unmount.
       - Add TypeScript declarations for `webkitSpeechRecognition` in the file (or a `.d.ts`):
         ```typescript
         interface Window { webkitSpeechRecognition: typeof SpeechRecognition; }
         ```

    3. **DualRangeSlider** (`src/components/shared/DualRangeSlider.tsx`):
       - Props: `min: number`, `max: number`, `value: [number, number]`, `onChange: (value: [number, number]) => void`, `step?: number`, `label?: string`, `formatValue?: (v: number) => string`.
       - Renders two native `<input type="range">` overlaid on a single track using absolute positioning.
       - Track styled with clay-shadow-inset (recessed rail look), thumbs styled with metal gradient (consistent with MetalSlider).
       - Logic: Left thumb max = right thumb value. Right thumb min = left thumb value. Prevents crossing.
       - Display current range values above the slider: `formatValue(value[0]) — formatValue(value[1])`.
       - ARIA: Both inputs have `aria-label` with "minimum" / "maximum" qualifiers, `aria-valuemin`, `aria-valuemax`, `aria-valuenow` (A11Y-03).
       - Visible focus rings via `focus-visible:ring-2 focus-visible:ring-accent` (A11Y-03).
  </action>
  <verify>
    - `npm run build` succeeds with no TypeScript errors
    - `grep -r "advancedFilters" src/stores/searchStore.ts` confirms new filter state
    - `grep -r "webkitSpeechRecognition\|SpeechRecognition" src/hooks/useVoiceSearch.ts` confirms voice support
    - `grep -r "aria-valuemin\|aria-valuenow" src/components/shared/DualRangeSlider.tsx` confirms ARIA
    - `grep -r "focus-visible" src/components/shared/DualRangeSlider.tsx` confirms focus rings
  </verify>
  <done>
    searchStore extended with advancedFilters, search cache Map, and proper TMDBMovie import. useVoiceSearch provides Web Speech API with feature detection and TypeScript declarations. DualRangeSlider renders two-thumb range input with metal styling, ARIA labels, and focus rings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build SearchModal with SearchBar, SearchResults, AdvancedFilters, FilterPresets, and VoiceSearchButton</name>
  <files>
    src/components/search/SearchModal.tsx
    src/components/search/SearchBar.tsx
    src/components/search/SearchResults.tsx
    src/components/search/AdvancedFilters.tsx
    src/components/search/FilterPresets.tsx
    src/components/search/VoiceSearchButton.tsx
  </files>
  <action>
    Per user decision: "Search accessed via icon in navbar — tap search icon to expand into search modal."
    Per user decision: "Advanced filters as expandable section above results."
    Per user decision: "Voice search with animated microphone — pulsing/glowing mic icon."

    1. **SearchBar** (`src/components/search/SearchBar.tsx`):
       - ClayInput for text entry with `placeholder="Search movies..."`.
       - Uses `useDebouncedValue(inputValue, 300)` for 300ms debounce (SRCH-01).
       - **Input sanitization** (SECU-02): Strip HTML tags via `input.replace(/<[^>]*>/g, '')` before sending to search. Limit input to 100 characters.
       - VoiceSearchButton rendered at the end of the input row (if supported).
       - `useEffect` triggers search when debounced value changes.
       - Search icon (Lucide Search) as input prefix.
       - Clear button (X icon) when input is non-empty.
       - Focus ring visible on keyboard navigation (A11Y-03).

    2. **VoiceSearchButton** (`src/components/search/VoiceSearchButton.tsx`):
       - Uses `useVoiceSearch` hook.
       - Only renders if `isSupported` is true.
       - Mic icon button (Lucide Mic). When listening: pulsing animation (Tailwind `animate-pulse` + ring glow using `ring-accent/50`).
       - On click: toggle listening. When transcript updates, populate SearchBar input.
       - ARIA: `aria-label="Voice search"`, `aria-pressed={isListening}` (A11Y-02).

    3. **SearchResults** (`src/components/search/SearchResults.tsx`):
       - Props: `results: TMDBMovie[]`, `onSelectMovie: (movieId: number) => void`, `isLoading: boolean`, `hasMore: boolean`, `onLoadMore: () => void`.
       - Renders results as a grid (grid-cols-2 mobile, grid-cols-3 tablet, grid-cols-4 desktop) of ClayCard items (SRCH-03).
       - Each result card: poster (getPosterUrl w185), title, year (from release_date), rating badge (vote_average as colored text).
       - Click on card calls `onSelectMovie(movie.id)` (SRCH-04).
       - Loading: ClaySkeletonCard grid.
       - Pagination: "Load More" MetalButton at bottom if `hasMore` is true (ADVS-06).
       - Empty state: "No movies found" message.
       - All cards have `tabIndex={0}` and `onKeyDown` Enter handler for keyboard access (A11Y-03).

    4. **AdvancedFilters** (`src/components/search/AdvancedFilters.tsx`):
       - Expandable section with ChevronDown toggle button (ADVS-01).
       - When expanded, shows:
         - **Genre multi-select**: Checkboxes using MetalCheckbox for each genre from getAllGenres(). Multiple selection (ADVS-01).
         - **Year range**: DualRangeSlider [1900, currentYear] with step 1 (ADVS-07).
         - **Rating range**: DualRangeSlider [0, 10] with step 0.5, formatValue shows one decimal (ADVS-07).
         - **Runtime range**: DualRangeSlider [0, 300] with step 15, formatValue shows "Xh Ym" (ADVS-07).
         - **Language**: MetalDropdown with top languages: English, Spanish, French, German, Japanese, Korean, Hindi, Chinese, Italian, Portuguese (ADVS-02).
         - **Streaming service**: MetalDropdown populated from useRegionProviders (ADVS-02).
         - **Sort by**: MetalDropdown with options: "Most Popular", "Highest Rated", "Newest", "Oldest" + ascending/descending toggle button (ADVS-03).
       - "Clear Filters" ghost MetalButton resets all to defaults.
       - All filter changes update `searchStore.advancedFilters` via `setAdvancedFilters`.
       - NOTE: Advanced search uses TMDB `/discover/movie` endpoint (not `/search/movie`) — when advanced filters are active, construct discover params from filter state and use `tmdbFetch` to call discover. When only text query is used (no advanced filters), use the existing `searchMovies` service. This distinction is critical.

    5. **FilterPresets** (`src/components/search/FilterPresets.tsx`):
       - Horizontal scrollable row of preset buttons (ADVS-04).
       - Presets (each sets specific advancedFilters + sortBy):
         - "90s Classics": yearRange [1990, 1999], ratingRange [7, 10], sort popularity.desc
         - "Hidden Gems": ratingRange [7, 10], sort vote_average.desc (low popularity)
         - "Short & Sweet": runtimeRange [0, 90], sort popularity.desc
         - "Epic Adventures": genres [12] (Adventure), runtimeRange [120, 300]
         - "Date Night": genres [10749] (Romance), ratingRange [6, 10]
         - "Family Fun": genres [10751] (Family), ratingRange [6, 10]
         - "Award Winners": ratingRange [8, 10], sort vote_average.desc
       - Each preset: ClayBadge variant="accent" button. Active preset highlighted.

    6. **SearchModal** (`src/components/search/SearchModal.tsx`):
       - Full-screen or large overlay modal (NOT using ClayModal — custom implementation for full-height search experience).
       - Props: `isOpen: boolean`, `onClose: () => void`.
       - Backdrop: fixed inset-0 bg-black/60 with onClick close (SRCH-05).
       - Content panel: clay-surface slide-up from bottom, max-h-[90vh], overflow-y-auto.
       - Close on Escape key via `useEffect` with keydown listener (SRCH-05).
       - Layout from top to bottom: SearchBar, FilterPresets, AdvancedFilters (collapsed by default), SearchResults.
       - Uses `useSearchMovies` hook for text search, direct `tmdbFetch('/discover/movie', ...)` for advanced filtered search.
       - `onSelectMovie`: Close modal, navigate to `/#/?movie={id}` (sets deep link, discovery page loads it).
       - Focus trap: Auto-focus search input on open (A11Y-03).
  </action>
  <verify>
    - `npm run build` succeeds with no TypeScript errors
    - `grep -r "useDebouncedValue" src/components/search/SearchBar.tsx` confirms 300ms debounce
    - `grep -r "replace.*<" src/components/search/SearchBar.tsx` confirms input sanitization
    - `grep -r "onSelectMovie" src/components/search/SearchResults.tsx` confirms click-to-view
    - `grep -r "Escape" src/components/search/SearchModal.tsx` confirms Escape key close
    - `grep -r "tabIndex\|onKeyDown" src/components/search/SearchResults.tsx` confirms keyboard access
  </verify>
  <done>
    SearchModal renders full search experience with text search (300ms debounce), voice search, advanced multi-criteria filters (genre, year, rating, runtime, language, provider, sort), filter presets, paginated results grid, and click-to-view navigation. Input sanitized against XSS. Closes on Escape and outside click. Keyboard navigable with focus rings.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero errors
- searchStore has advancedFilters state and search cache
- SearchModal opens/closes with Escape key and outside click
- Text search debounces at 300ms
- Voice search button only appears when Web Speech API is supported
- DualRangeSlider renders two thumbs that cannot cross
- Advanced filters construct TMDB discover params correctly
- All interactive elements have visible focus rings
- Search input strips HTML tags
</verification>

<success_criteria>
- User can search movies via debounced text input
- User can use voice search with visual microphone feedback
- User can apply advanced filters (genre, year, rating, runtime, language, provider, sort)
- User can use quick filter presets
- Search results show poster, title, year, rating and support pagination
- Clicking a search result loads the movie on the discovery screen
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-features/03-03-SUMMARY.md`
</output>
