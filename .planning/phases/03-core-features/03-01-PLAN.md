---
phase: 03-core-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/movie/RatingBadges.tsx
  - src/components/movie/GenreBadges.tsx
  - src/components/movie/ProviderSection.tsx
  - src/components/movie/MovieActions.tsx
  - src/components/movie/MovieHero.tsx
  - src/components/movie/TrailerLink.tsx
  - src/components/shared/ExternalLink.tsx
  - src/components/shared/ScreenReaderAnnouncer.tsx
  - src/components/shared/Toast.tsx
  - src/hooks/useDebouncedValue.ts
  - src/hooks/useSimilarMovies.ts
  - src/hooks/useDeepLink.ts
  - package.json
autonomous: true
requirements:
  - DISP-01
  - DISP-02
  - DISP-03
  - DISP-04
  - DISP-05
  - DISP-06
  - DISP-07
  - INTR-05
  - SECU-04
  - A11Y-02
  - A11Y-04

must_haves:
  truths:
    - "Movie poster renders with lazy loading and a fallback placeholder when image fails"
    - "Triple ratings (TMDB, IMDb, Rotten Tomatoes) display as colored badges with green/yellow/red scoring"
    - "Streaming availability groups providers into Stream/Rent/Buy sections with logos"
    - "Genre badges render as claymorphism-styled pills"
    - "Action buttons (Love, Watched, Not Interested, Next) render below movie details"
    - "Toast notifications fire for user actions"
    - "External links include rel='noopener noreferrer' and target='_blank'"
    - "ARIA live region announces dynamic content changes to screen readers"
  artifacts:
    - path: "src/components/movie/RatingBadges.tsx"
      provides: "Triple ratings display with colored badges"
      contains: "RatingBadges"
    - path: "src/components/movie/ProviderSection.tsx"
      provides: "Streaming provider grouped list"
      contains: "ProviderSection"
    - path: "src/components/movie/MovieHero.tsx"
      provides: "Cinematic hero with backdrop, poster, metadata"
      contains: "MovieHero"
    - path: "src/components/movie/MovieActions.tsx"
      provides: "Love/Watched/Not Interested/Next buttons"
      contains: "MovieActions"
    - path: "src/components/shared/ExternalLink.tsx"
      provides: "Secure external link component"
      contains: "noopener noreferrer"
    - path: "src/components/shared/ScreenReaderAnnouncer.tsx"
      provides: "ARIA live region for dynamic announcements"
      contains: "aria-live"
    - path: "src/hooks/useSimilarMovies.ts"
      provides: "Fetches similar movies for Love action"
      contains: "useSimilarMovies"
    - path: "src/hooks/useDeepLink.ts"
      provides: "Handles ?movie=ID deep linking"
      contains: "useDeepLink"
  key_links:
    - from: "src/components/movie/RatingBadges.tsx"
      to: "useOmdbRatings hook"
      via: "receives imdbRating, rottenTomatoes, metascore as props"
      pattern: "imdbRating|rottenTomatoes|metascore"
    - from: "src/components/movie/ProviderSection.tsx"
      to: "useWatchProviders hook"
      via: "receives MovieProviders as props"
      pattern: "flatrate|rent|buy"
    - from: "src/components/movie/MovieActions.tsx"
      to: "movieHistoryStore + preferencesStore"
      via: "calls markLoved/markWatched/markNotInterested + recordLove"
      pattern: "markLoved|markWatched|markNotInterested"
---

<objective>
Build all reusable movie display components, shared utilities, and new hooks that every feature page depends on.

Purpose: Provides the visual building blocks (MovieHero, RatingBadges, ProviderSection, GenreBadges, MovieActions) and cross-cutting infrastructure (toast, ExternalLink, ScreenReaderAnnouncer, useSimilarMovies, useDeepLink, useDebouncedValue) consumed by Discovery, Trending, Search, Dinner Time, and Free Movies pages in subsequent plans.

Output: 10+ components and 3 new hooks ready for composition by page-level components.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/movie.ts
@src/types/provider.ts
@src/stores/movieHistoryStore.ts
@src/stores/preferencesStore.ts
@src/stores/discoveryStore.ts
@src/hooks/useOmdbRatings.ts
@src/hooks/useWatchProviders.ts
@src/hooks/useRandomMovie.ts
@src/services/tmdb/client.ts
@src/lib/genre-map.ts
@src/lib/provider-registry.ts
@src/components/ui/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sonner + create shared infrastructure components and new hooks</name>
  <files>
    package.json
    src/components/shared/ExternalLink.tsx
    src/components/shared/ScreenReaderAnnouncer.tsx
    src/components/shared/Toast.tsx
    src/hooks/useDebouncedValue.ts
    src/hooks/useSimilarMovies.ts
    src/hooks/useDeepLink.ts
  </files>
  <action>
    1. **Install sonner**: `npm install sonner` (~3KB toast library). No other new dependencies for Phase 3.

    2. **ExternalLink** (`src/components/shared/ExternalLink.tsx`):
       - Wrapper around `<a>` that ALWAYS sets `rel="noopener noreferrer"` and `target="_blank"` (SECU-04).
       - Props: `href`, `children`, `className?`, plus remaining anchor props via `...rest`.
       - Renders a styled `<a>` with the security attributes.

    3. **ScreenReaderAnnouncer** (`src/components/shared/ScreenReaderAnnouncer.tsx`):
       - Renders a visually hidden `<div aria-live="polite" aria-atomic="true">` with sr-only Tailwind class (A11Y-04).
       - Accepts `message: string` prop. When message changes, screen readers announce it.
       - Export a companion `useAnnounce` hook that returns `[announce: (msg: string) => void, AnnouncerComponent]` for easy usage.

    4. **Toast** (`src/components/shared/Toast.tsx`):
       - Integrate sonner's `<Toaster>` component with claymorphism styling (INTR-05).
       - Export `<ToastProvider>` that renders `<Toaster position="bottom-center" toastOptions={{ className: 'clay-toast', style: { background: 'var(--clay-surface)', color: 'var(--clay-text)', border: '2px solid var(--clay-border)' } }} />`.
       - Export `showToast(message: string, type?: 'success' | 'error' | 'info')` helper wrapping `toast()` from sonner.
       - Toast must appear styled with clay surface colors from the theme system.

    5. **useDebouncedValue** (`src/hooks/useDebouncedValue.ts`):
       - Generic hook: `useDebouncedValue<T>(value: T, delay: number): T`.
       - Uses `useState` + `useEffect` with `setTimeout`/`clearTimeout`.
       - Returns debounced value that updates `delay` ms after last `value` change.

    6. **useSimilarMovies** (`src/hooks/useSimilarMovies.ts`):
       - Calls TMDB `/movie/{id}/similar` via `tmdbFetch` from `@/services/tmdb/client`.
       - Signature: `useSimilarMovies(movieId: number | null)` returns `{ movies: TMDBMovie[], isLoading: boolean }`.
       - Uses cancelled flag pattern for cleanup (same pattern as useMovieDetails).
       - Caches results via cache-manager with `TTL.SEARCH_RESULTS`.

    7. **useDeepLink** (`src/hooks/useDeepLink.ts`):
       - Uses `useSearchParams` from `react-router` to read `?movie=ID` from URL hash.
       - Returns `{ deepLinkMovieId: number | null, clearDeepLink: () => void }`.
       - `clearDeepLink` removes the `movie` param from URL without navigation.
       - Must work with HashRouter (URL format: `/#/?movie=123`).
  </action>
  <verify>
    - `npm run build` succeeds with no TypeScript errors
    - All 7 files exist and export their documented interfaces
    - `grep -r "noopener noreferrer" src/components/shared/ExternalLink.tsx` finds the security attributes
    - `grep -r "aria-live" src/components/shared/ScreenReaderAnnouncer.tsx` finds the live region
  </verify>
  <done>
    sonner installed, ExternalLink enforces secure links, ScreenReaderAnnouncer provides ARIA live region, Toast integrates sonner with clay styling, useDebouncedValue provides generic debounce, useSimilarMovies fetches /movie/{id}/similar, useDeepLink reads ?movie=ID from URL
  </done>
</task>

<task type="auto">
  <name>Task 2: Build movie display components — MovieHero, RatingBadges, GenreBadges, ProviderSection, MovieActions, TrailerLink</name>
  <files>
    src/components/movie/MovieHero.tsx
    src/components/movie/RatingBadges.tsx
    src/components/movie/GenreBadges.tsx
    src/components/movie/ProviderSection.tsx
    src/components/movie/MovieActions.tsx
    src/components/movie/TrailerLink.tsx
  </files>
  <action>
    Per user decision: "Cinematic hero style for discovery view" — full-bleed backdrop image with title overlay.
    Per user decision: "Colored rating badges" — each rating as colored badge/chip with source logo, green/yellow/red based on score.
    Per user decision: "Streaming availability as grouped list" — vertical list grouped by Stream/Rent/Buy.
    Per user decision: "Genre badges as clay-styled pills" — claymorphism-styled rounded pills.
    Per user decision: "Action buttons match existing vanilla app placement (below the movie card)."

    1. **MovieHero** (`src/components/movie/MovieHero.tsx`):
       - Props: `movie: TMDBMovieDetails` (from `@/types/movie`).
       - Renders full-bleed backdrop image (via `getBackdropUrl` from tmdb/client) with gradient overlay fading to transparent at top.
       - Poster image (via `getPosterUrl`, w342 size) positioned at left side over the backdrop.
       - Lazy loading: `<img loading="lazy">` on both poster and backdrop (DISP-01).
       - Error fallback: `onError` handler replaces poster src with a Film icon placeholder div (gray bg with Lucide Film icon).
       - Movie metadata overlay: title (font-heading text-2xl), release year (extracted from release_date), runtime (formatted as "Xh Ym"), overview paragraph.
       - GenreBadges rendered inline below title.
       - All text uses `text-clay-text` for theme compatibility.
       - ARIA: `role="img"` on backdrop with `aria-label` describing the movie (A11Y-02).

    2. **RatingBadges** (`src/components/movie/RatingBadges.tsx`):
       - Props: `tmdbRating: number` (vote_average), `imdbRating: string | null`, `rottenTomatoes: string | null`, `metascore?: string | null`.
       - Each rating renders as a ClayBadge with:
         - Small icon/logo (TMDB: star icon, IMDb: "IMDb" text badge, RT: tomato emoji or "RT" text, Metacritic: "MC" text).
         - Score value.
         - Color coding: green (>=7.0 / >=70%), yellow (>=5.0 / >=50%), red (<5.0 / <50%). Use Tailwind `bg-green-500/20 text-green-400`, `bg-yellow-500/20 text-yellow-400`, `bg-red-500/20 text-red-400` over clay surface.
       - Horizontal flex row with gap-2.
       - Hides any rating that is null.
       - Displays TMDB as percentage (multiply by 10, round). IMDb as "/10". RT as "%".

    3. **GenreBadges** (`src/components/movie/GenreBadges.tsx`):
       - Props: `genres: Array<{ id: number; name: string }>`.
       - Maps genres to ClayBadge components in a flex-wrap row.
       - Each badge uses `variant="muted"` for soft clay pill styling.
       - Limits display to first 4 genres, shows "+N more" if truncated.

    4. **ProviderSection** (`src/components/movie/ProviderSection.tsx`):
       - Props: `providers: MovieProviders` (from `@/types/provider`), `findMovieLink?: string`.
       - Groups providers into sections: "Stream" (flatrate), "Rent" (rent), "Buy" (buy), "Free" (free+ads).
       - Each section: heading label + horizontal list of provider logos (via `getProviderLogoUrl` from provider-registry).
       - Each logo wrapped in ExternalLink pointing to `providers.tmdb_link`.
       - Logo: 40x40 rounded-lg image with `alt={provider_name}`.
       - If no providers at all, show "Not available in your region" message with a "Find Movie" button (DISP-05) that links to `findMovieLink` (TMDB search URL) via ExternalLink.
       - Section uses ARIA labels: `aria-label="Streaming availability"` (A11Y-02).

    5. **MovieActions** (`src/components/movie/MovieActions.tsx`):
       - Props: `movieId: number`, `movieGenres: Array<{id: number; name: string}>`, `releaseYear: string`, `directorId?: number`, `onNext: () => void`, `onLove: () => void`.
       - Four MetalButton components in a horizontal row:
         - Heart icon + "Love it" — calls `onLove` prop (parent handles store + similar movies logic).
         - Eye icon + "Watched" — calls `movieHistoryStore.markWatched(movieId)` + `showToast('Marked as watched')` + `onNext()`.
         - ThumbsDown icon + "Not Interested" — calls `movieHistoryStore.markNotInterested(movieId)` + `preferencesStore.recordNotInterested(genres, decade, directorId)` + `showToast('Skipped')` + `onNext()`.
         - SkipForward icon + "Next" — calls `onNext()`.
       - Uses Lucide icons: Heart, Eye, ThumbsDown, SkipForward.
       - Buttons use `variant="secondary"` with `size="sm"` for compact layout.
       - Responsive: 2x2 grid on mobile (grid-cols-2), single row on desktop (sm:flex).

    6. **TrailerLink** (`src/components/movie/TrailerLink.tsx`):
       - Props: `videos: TMDBMovieDetails['videos']`.
       - Finds first YouTube trailer from `videos.results` where `site === 'YouTube'` and `type === 'Trailer'`.
       - Falls back to any YouTube video if no trailer type found.
       - Renders ExternalLink to `https://www.youtube.com/watch?v={key}` with Play icon + "Watch Trailer" text.
       - Styled as MetalButton with `variant="ghost"`.
       - Renders nothing if no YouTube videos found.
  </action>
  <verify>
    - `npm run build` succeeds with no TypeScript errors
    - All 6 component files exist under src/components/movie/
    - `grep -r "loading=\"lazy\"" src/components/movie/MovieHero.tsx` confirms lazy loading
    - `grep -r "ClayBadge" src/components/movie/RatingBadges.tsx` confirms clay styling
    - `grep -r "ExternalLink" src/components/movie/ProviderSection.tsx` confirms secure links
    - `grep -r "aria-label" src/components/movie/ProviderSection.tsx` confirms ARIA labels
  </verify>
  <done>
    MovieHero renders cinematic full-bleed backdrop with poster, title, year, runtime, overview, and genre badges. RatingBadges shows TMDB/IMDb/RT/Metacritic as colored clay badges. GenreBadges renders clay pill chips. ProviderSection groups streaming providers by tier with logos and secure links. MovieActions provides Love/Watched/Not Interested/Next buttons with store integration. TrailerLink renders YouTube trailer button. All components use lazy loading, ARIA labels, and secure external links.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero errors
- All shared components exist: ExternalLink, ScreenReaderAnnouncer, Toast
- All movie components exist: MovieHero, RatingBadges, GenreBadges, ProviderSection, MovieActions, TrailerLink
- All new hooks exist: useDebouncedValue, useSimilarMovies, useDeepLink
- sonner is in package.json dependencies
- Security: ExternalLink always applies rel="noopener noreferrer"
- Accessibility: ScreenReaderAnnouncer has aria-live, all interactive elements have ARIA labels
</verification>

<success_criteria>
- 10 new components and 3 new hooks compile and export correctly
- sonner toast system works with clay theme styling
- Movie display components accept typed props from Phase 2 types
- No circular dependencies between new components
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-features/03-01-SUMMARY.md`
</output>
