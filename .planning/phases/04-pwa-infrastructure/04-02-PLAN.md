---
phase: 04-pwa-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - src/components/pwa/ReloadPrompt.tsx
  - src/components/pwa/InstallBanner.tsx
  - src/hooks/useInstallPrompt.ts
  - src/App.tsx
autonomous: true
requirements:
  - PWA-03
  - PWA-04

must_haves:
  truths:
    - "User sees a toast notification when a new app version is available with option to reload"
    - "User sees an offline-ready confirmation when service worker finishes caching"
    - "User on Chrome/Edge/Android sees an install banner with a native install button"
    - "User on iOS Safari sees install instructions showing Share > Add to Home Screen steps"
    - "Install banner does not reappear for 7 days after dismissal"
    - "No install banner shows when app is already installed (standalone mode)"
  artifacts:
    - path: "src/components/pwa/ReloadPrompt.tsx"
      provides: "Update notification toast using useRegisterSW"
      contains: "useRegisterSW"
    - path: "src/components/pwa/InstallBanner.tsx"
      provides: "Install prompt banner with iOS detection"
      contains: "useInstallPrompt"
    - path: "src/hooks/useInstallPrompt.ts"
      provides: "beforeinstallprompt capture + iOS detection hook"
      contains: "beforeinstallprompt"
    - path: "src/App.tsx"
      provides: "ReloadPrompt and InstallBanner mounted at app root"
      contains: "ReloadPrompt"
  key_links:
    - from: "src/components/pwa/ReloadPrompt.tsx"
      to: "virtual:pwa-register/react"
      via: "useRegisterSW import"
      pattern: "from 'virtual:pwa-register/react'"
    - from: "src/components/pwa/InstallBanner.tsx"
      to: "src/hooks/useInstallPrompt.ts"
      via: "hook import"
      pattern: "useInstallPrompt"
    - from: "src/App.tsx"
      to: "src/components/pwa/ReloadPrompt.tsx"
      via: "component import and mount"
      pattern: "ReloadPrompt"
---

<objective>
Build the user-facing PWA components: a ReloadPrompt toast for update notifications and an InstallBanner for install prompts (Chromium native + iOS instructions).

Purpose: Without these, the service worker works silently but users never know they can install or update the app.
Output: Two React components (ReloadPrompt, InstallBanner), one custom hook (useInstallPrompt), both mounted in App.tsx.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pwa-infrastructure/04-RESEARCH.md
@.planning/phases/04-pwa-infrastructure/04-01-SUMMARY.md
@src/App.tsx
@src/components/ui/ClayCard.tsx
@src/styles/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useInstallPrompt hook and InstallBanner component</name>
  <files>src/hooks/useInstallPrompt.ts, src/components/pwa/InstallBanner.tsx</files>
  <action>
1. Create `src/hooks/useInstallPrompt.ts`:
   - Define `BeforeInstallPromptEvent` interface extending Event with `prompt(): Promise<void>` and `userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>`
   - Constants: `INSTALL_DISMISSED_KEY = 'wmtw-pwa-install-dismissed'` (uses project's wmtw- key prefix convention), `DAYS_BEFORE_REPROMPT = 7`
   - Hook state: `installEvent` (BeforeInstallPromptEvent | null), `isIOS` (boolean), `isInstalled` (boolean), `showPrompt` (boolean)
   - useEffect logic:
     a. Check standalone mode: `window.matchMedia('(display-mode: standalone)').matches || (navigator as any).standalone === true` — if true, set isInstalled and return early
     b. iOS detection: `/iPad|iPhone|iPod/.test(navigator.userAgent) && !(window as any).MSStream`
     c. Check localStorage for recent dismissal — if dismissed less than 7 days ago, return early
     d. If iOS: `setTimeout(() => setShowPrompt(true), 3000)` then return
     e. If not iOS (Chromium): add `beforeinstallprompt` listener that calls `e.preventDefault()`, stores event, then `setTimeout(() => setShowPrompt(true), 2000)`. Also add `appinstalled` listener that sets isInstalled=true, showPrompt=false
     f. Cleanup: remove beforeinstallprompt listener
   - `install` async function: call `installEvent.prompt()`, await `installEvent.userChoice`, if dismissed call `dismiss()`, reset installEvent and showPrompt
   - `dismiss` function: set localStorage key to `String(Date.now())`, set showPrompt=false
   - Return: `{ showPrompt, isIOS, isInstalled, install, dismiss }`

2. Create `src/components/pwa/InstallBanner.tsx`:
   - Import useInstallPrompt hook
   - Import lucide-react icons: `Download`, `X`, `Share` (for iOS share icon reference)
   - If `!showPrompt || isInstalled` → return null
   - Render a fixed bottom banner (positioned above the TabBar which is 80px — use `bottom-24`):
     - Use claymorphism styling: `bg-surface-clay/95 backdrop-blur-md border border-clay-border rounded-2xl shadow-clay-md mx-4 p-4`
     - Dismiss button (X icon) in top-right corner, calls `dismiss()`
     - Two variants:
       a. **Chromium** (when `!isIOS`): Show app icon, "Install Which Movie To Watch" title, "Add to home screen for quick access" subtitle, and a primary button "Install" that calls `install()`. Use MetalButton or a styled button with the project's gradient accent.
       b. **iOS** (when `isIOS`): Show instructions text: "To install, tap the Share button" (with Share icon inline) "then 'Add to Home Screen'". No install button (iOS has no programmatic install). Include a small step-by-step: 1. Tap Share icon, 2. Scroll down, 3. Tap "Add to Home Screen".
     - Banner should have a subtle enter animation — use `motion/react` AnimatePresence + motion.div with initial={{ y: 100, opacity: 0 }} animate={{ y: 0, opacity: 1 }} exit={{ y: 100, opacity: 0 }}
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify the hook file exports useInstallPrompt. Verify InstallBanner imports and uses the hook correctly.</verify>
  <done>useInstallPrompt hook captures beforeinstallprompt on Chromium, detects iOS, respects 7-day dismissal cooldown. InstallBanner renders platform-specific install UI with claymorphism styling.</done>
</task>

<task type="auto">
  <name>Task 2: Create ReloadPrompt component and mount PWA components in App.tsx</name>
  <files>src/components/pwa/ReloadPrompt.tsx, src/App.tsx</files>
  <action>
1. Create `src/components/pwa/ReloadPrompt.tsx`:
   - Import `useRegisterSW` from `'virtual:pwa-register/react'` (this virtual module is typed by the reference in vite-env.d.ts from Plan 01)
   - Import lucide-react icons: `RefreshCw`, `X`, `Wifi`
   - Import `motion/react` for animation
   - Call `useRegisterSW` with config:
     - `onRegistered(r)`: if r exists, set up hourly update check: `setInterval(() => r.update(), 60 * 60 * 1000)`
     - `onRegisterError(error)`: `console.error('SW registration error', error)`
   - Destructure: `offlineReady: [offlineReady, setOfflineReady]`, `needRefresh: [needRefresh, setNeedRefresh]`, `updateServiceWorker`
   - `close` function: `setOfflineReady(false)` and `setNeedRefresh(false)`
   - If `!offlineReady && !needRefresh` → return null
   - Render a fixed toast in bottom-right corner (`fixed bottom-24 right-4 z-50`):
     - Claymorphism card styling: `bg-surface-clay/95 backdrop-blur-md border border-clay-border rounded-xl shadow-clay-md p-4 max-w-sm`
     - Two states:
       a. **offlineReady**: Show Wifi icon + "App ready to work offline" text + dismiss button (X)
       b. **needRefresh**: Show RefreshCw icon + "New version available" text + "Update" button (calls `updateServiceWorker(true)`) + dismiss button (X)
     - "Update" button: use accent gradient styling (matches project theme)
     - Animate with motion.div: initial={{ x: 100, opacity: 0 }} animate={{ x: 0, opacity: 1 }} exit={{ x: 100, opacity: 0 }}
   - Auto-dismiss offlineReady after 5 seconds: `useEffect` with setTimeout when offlineReady is true

2. Update `src/App.tsx`:
   - Add imports for `ReloadPrompt` from `'@/components/pwa/ReloadPrompt'` and `InstallBanner` from `'@/components/pwa/InstallBanner'`
   - Mount BOTH components inside the fragment, AFTER the existing content (after the `{!showSplash && ...}` block, before the closing fragment):
     ```
     <ReloadPrompt />
     <InstallBanner />
     ```
   - These render outside the splash screen guard intentionally — the service worker registers immediately, and the install banner should show regardless of splash state.
   - Keep ALL existing App.tsx content unchanged (ToastProvider, AnimatePresence, SplashScreen, AppShell, TabBar).
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Run `npm run build` — build succeeds. Run `npm run preview` — verify in Chrome DevTools Application tab that service worker is registered. Check that the ReloadPrompt appears briefly with "App ready to work offline" on first load (then auto-dismisses).</verify>
  <done>ReloadPrompt shows update/offline-ready toasts with dismiss and reload actions. InstallBanner shows platform-appropriate install UI. Both mounted in App.tsx outside splash guard. Full PWA lifecycle (register, cache, update, install) is user-facing.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. `npx tsc --noEmit` passes with no type errors
3. `npm run preview` — on first load:
   - Service worker registers (Application tab)
   - "App ready to work offline" toast appears briefly then auto-dismisses
4. Chrome's Lighthouse PWA audit passes core checks (manifest, service worker, offline)
5. Install banner logic: on non-standalone Chromium browser, banner appears after 2s delay
6. iOS detection: on iOS Safari (or simulated), shows Share > Add to Home Screen instructions
</verification>

<success_criteria>
- ReloadPrompt shows "offline ready" on first SW activation and "update available" when new version detected
- InstallBanner shows native install button on Chromium and step-by-step instructions on iOS
- Install banner respects 7-day dismissal cooldown via localStorage (wmtw-pwa-install-dismissed key)
- Neither prompt appears when app is already in standalone mode (installed)
- Both components use claymorphism styling consistent with the design system
- App.tsx mounts both PWA components without disrupting existing layout
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-infrastructure/04-02-SUMMARY.md`
</output>
