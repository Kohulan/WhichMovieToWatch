---
phase: 04-pwa-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - src/vite-env.d.ts
  - public/offline.html
  - public/favicon_io/android-chrome-192x192.png
  - public/favicon_io/android-chrome-512x512.png
  - public/favicon_io/apple-touch-icon.png
  - public/favicon_io/favicon.ico
  - public/favicon_io/favicon-16x16.png
  - public/favicon_io/favicon-32x32.png
  - index.html
  - package.json
autonomous: true
requirements:
  - PWA-01
  - PWA-02
  - PWA-05
  - PWA-06

must_haves:
  truths:
    - "Service worker registers on page load and precaches static assets"
    - "Offline fallback page displays when user navigates without network and no cache exists"
    - "TMDB API responses are cached via NetworkFirst strategy for offline resilience"
    - "TMDB images are cached via CacheFirst strategy for fast repeated loads"
    - "Web app manifest declares app name, icons, theme color, and standalone display mode"
  artifacts:
    - path: "vite.config.ts"
      provides: "VitePWA plugin with manifest, workbox runtimeCaching, and offline fallback"
      contains: "VitePWA"
    - path: "public/offline.html"
      provides: "Self-contained offline fallback page with retry logic"
      contains: "You're Offline"
    - path: "src/vite-env.d.ts"
      provides: "TypeScript virtual module types for PWA"
      contains: "vite-plugin-pwa/react"
    - path: "public/favicon_io/android-chrome-512x512.png"
      provides: "PWA icon for manifest"
  key_links:
    - from: "vite.config.ts"
      to: "public/offline.html"
      via: "workbox.navigateFallback"
      pattern: "navigateFallback.*offline\\.html"
    - from: "vite.config.ts"
      to: "public/favicon_io/*.png"
      via: "manifest.icons src paths"
      pattern: "favicon_io/android-chrome"
---

<objective>
Install vite-plugin-pwa, configure service worker generation with Workbox runtime caching strategies, set up the web app manifest, copy icons to public/, and create the offline fallback page.

Purpose: This is the foundational PWA infrastructure — everything else (install prompts, update notifications) depends on a registered service worker and valid manifest.
Output: Working service worker with multi-layer caching, valid manifest, offline fallback page, icons in public/.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pwa-infrastructure/04-RESEARCH.md
@vite.config.ts
@src/vite-env.d.ts
@index.html
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vite-plugin-pwa and configure service worker + manifest in vite.config.ts</name>
  <files>package.json, vite.config.ts, src/vite-env.d.ts</files>
  <action>
1. Run `npm install -D vite-plugin-pwa` to add the plugin (workbox-window and workbox-build are bundled automatically).

2. Update `vite.config.ts`:
   - Import `{ VitePWA }` from `'vite-plugin-pwa'`
   - Add `VitePWA({...})` to the plugins array AFTER react() and tailwindcss()
   - Configure with these exact settings:
     - `registerType: 'prompt'` (NOT autoUpdate — avoids reloading during onboarding form, per research)
     - `injectRegister: 'auto'`
     - `includeAssets: ['offline.html', 'favicon_io/*.png', 'favicon_io/favicon.ico']`
     - `manifest` object with:
       - `name: 'Which Movie To Watch'`
       - `short_name: 'MovieWatch'`
       - `description: 'Find your next favorite movie with personalized recommendations'`
       - `theme_color: '#0E0E12'`
       - `background_color: '#0E0E12'`
       - `display: 'standalone'`
       - `start_url: '/'`
       - `orientation: 'portrait-primary'`
       - `categories: ['entertainment', 'movies', 'lifestyle']`
       - `icons` array with THREE entries:
         - `{ src: 'favicon_io/android-chrome-192x192.png', sizes: '192x192', type: 'image/png' }`
         - `{ src: 'favicon_io/android-chrome-512x512.png', sizes: '512x512', type: 'image/png' }` (purpose defaults to 'any')
         - `{ src: 'favicon_io/android-chrome-512x512.png', sizes: '512x512', type: 'image/png', purpose: 'maskable' }` (separate entry per web.dev recommendation — do NOT combine 'any maskable')
     - `workbox` object with:
       - `globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}']` (MUST include html — prevents WorkboxError: non-precached-url)
       - `navigateFallback: '/offline.html'`
       - `navigateFallbackDenylist: [/^\/api\//]`
       - `cleanupOutdatedCaches: true`
       - `runtimeCaching` array with THREE entries:
         1. TMDB API (NetworkFirst): `urlPattern: /^https:\/\/api\.themoviedb\.org\/.*/i`, handler: 'NetworkFirst', cacheName: 'tmdb-api-cache', expiration maxEntries: 200, maxAgeSeconds: 86400 (24h), cacheableResponse statuses [0, 200], networkTimeoutSeconds: 10
         2. OMDB API (NetworkFirst): `urlPattern: /^https:\/\/www\.omdbapi\.com\/.*/i`, handler: 'NetworkFirst', cacheName: 'omdb-api-cache', expiration maxEntries: 100, maxAgeSeconds: 604800 (7 days), cacheableResponse statuses [0, 200], networkTimeoutSeconds: 10
         3. TMDB Images (CacheFirst): `urlPattern: /^https:\/\/image\.tmdb\.org\/.*/i`, handler: 'CacheFirst', cacheName: 'tmdb-images-cache', expiration maxEntries: 500, maxAgeSeconds: 2592000 (30 days), cacheableResponse statuses [0, 200]
     - `devOptions: { enabled: true, type: 'module', navigateFallback: 'index.html' }` for dev testing
   - Keep ALL existing config (react(), tailwindcss(), base, resolve.alias, build.rollupOptions) unchanged.

3. Update `src/vite-env.d.ts`:
   - Add `/// <reference types="vite-plugin-pwa/react" />` on line 1 (BEFORE the existing vite/client reference).
   - Keep all existing ImportMetaEnv and ImportMeta interfaces unchanged.
  </action>
  <verify>Run `npm run build` — should succeed without errors. Check that `dist/` contains a generated service worker file (sw.js or similar). Verify `dist/manifest.webmanifest` exists and contains correct icon paths.</verify>
  <done>vite-plugin-pwa installed, vite.config.ts has VitePWA plugin with manifest + workbox config, vite-env.d.ts has PWA type reference, build produces service worker and manifest.</done>
</task>

<task type="auto">
  <name>Task 2: Copy icons to public/, create offline.html, update index.html icon references</name>
  <files>public/favicon_io/android-chrome-192x192.png, public/favicon_io/android-chrome-512x512.png, public/favicon_io/apple-touch-icon.png, public/favicon_io/favicon.ico, public/favicon_io/favicon-16x16.png, public/favicon_io/favicon-32x32.png, public/offline.html, index.html</files>
  <action>
1. Copy icon files from `assets/favicon_io/` to `public/favicon_io/`:
   - `mkdir -p public/favicon_io`
   - Copy all 6 files: android-chrome-192x192.png, android-chrome-512x512.png, apple-touch-icon.png, favicon.ico, favicon-16x16.png, favicon-32x32.png
   - These must be in `public/` so Vite copies them to `dist/` at build time and the manifest icon paths resolve correctly.

2. Create `public/offline.html` by adapting the existing `offline.html` from the repo root:
   - Copy the content but make these changes:
     - Remove the `<link rel="manifest" href="/site.webmanifest">` line (the PWA plugin handles manifest injection; this old reference would 404)
     - Update the "View Cached Movies" button's `viewCachedContent()` function: instead of navigating to `/`, navigate to `/#/` since the React app uses HashRouter
     - In `retryConnection()`, change `window.location.href = '/'` to `window.location.href = '/#/'` for the same reason
     - Keep ALL existing styling and layout unchanged — it already matches the app's dark theme
   - Do NOT create this as a React component. It MUST be self-contained HTML (no React, no JS imports) because it serves when the main bundle is unavailable.

3. Update `index.html` icon references:
   - Change all icon `href` paths from `/assets/favicon_io/...` to `/favicon_io/...` since icons now live in `public/favicon_io/` (Vite serves `public/` contents at root path)
   - Lines to update:
     - `<link rel="icon" type="image/x-icon" href="/favicon_io/favicon.ico" />`
     - `<link rel="icon" type="image/png" sizes="32x32" href="/favicon_io/favicon-32x32.png" />`
     - `<link rel="icon" type="image/png" sizes="16x16" href="/favicon_io/favicon-16x16.png" />`
     - `<link rel="apple-touch-icon" sizes="180x180" href="/favicon_io/apple-touch-icon.png" />`
   - Keep everything else in index.html unchanged.
  </action>
  <verify>Run `npm run build`. Verify: (1) `dist/favicon_io/` contains all 6 icon files. (2) `dist/offline.html` exists and does NOT contain `site.webmanifest` reference. (3) `dist/index.html` has icon hrefs starting with `/favicon_io/` (not `/assets/favicon_io/`). (4) Run `npm run preview` and check dev tools Application tab shows registered service worker.</verify>
  <done>Icons in public/favicon_io/, offline.html adapted for HashRouter in public/, index.html icon paths updated. Build output contains all PWA assets.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `dist/sw.js` (or equivalent) exists — service worker was generated
3. `dist/manifest.webmanifest` exists with correct name, icons, display: standalone
4. `dist/offline.html` exists, is self-contained HTML, has no manifest link
5. `dist/favicon_io/` contains all icon files
6. `npm run preview` — Application tab in Chrome DevTools shows:
   - Service worker: registered and active
   - Manifest: detected with correct metadata
   - Cache Storage: contains precached assets after first load
</verification>

<success_criteria>
- Service worker registers and precaches static assets on first visit
- Workbox runtimeCaching rules target TMDB API (NetworkFirst), OMDB API (NetworkFirst), TMDB images (CacheFirst)
- Web app manifest has correct name, icons (192x192 + 512x512 any + 512x512 maskable), standalone display
- Offline fallback page exists at /offline.html with retry and cached content navigation
- Build produces all expected artifacts in dist/
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-infrastructure/04-01-SUMMARY.md`
</output>
