---
phase: 04-pwa-infrastructure
plan: 01
subsystem: infra
tags: [pwa, service-worker, workbox, vite-plugin-pwa, manifest, offline, caching]

# Dependency graph
requires:
  - phase: 03-core-features
    provides: Vite + React app with stable build output for precaching

provides:
  - Service worker generated by Workbox via vite-plugin-pwa with NetworkFirst/CacheFirst strategies
  - Web app manifest with name, icons (192x192, 512x512 any, 512x512 maskable), standalone display
  - Offline fallback page at /offline.html with HashRouter-aware navigation
  - All PWA icons in public/favicon_io/ for correct manifest path resolution
  - dist/sw.js, dist/manifest.webmanifest, dist/offline.html generated by build

affects:
  - 04-02 (install prompts, update notifications depend on registered service worker and registerType: 'prompt')

# Tech tracking
tech-stack:
  added:
    - vite-plugin-pwa@1.x (workbox-build, workbox-window bundled)
  patterns:
    - VitePWA with registerType: 'prompt' avoids reload interrupting onboarding wizard
    - Three runtimeCaching entries: NetworkFirst for APIs (10s timeout), CacheFirst for images (30-day TTL)
    - Separate maskable icon entry (not combined 'any maskable') per web.dev recommendation
    - offline.html in public/ is self-contained HTML — no React, no JS imports
    - HashRouter navigation uses /#/ in offline.html redirect targets

key-files:
  created:
    - public/offline.html
    - public/favicon_io/android-chrome-192x192.png
    - public/favicon_io/android-chrome-512x512.png
    - public/favicon_io/apple-touch-icon.png
    - public/favicon_io/favicon.ico
    - public/favicon_io/favicon-16x16.png
    - public/favicon_io/favicon-32x32.png
  modified:
    - vite.config.ts
    - src/vite-env.d.ts
    - index.html
    - package.json
    - package-lock.json

key-decisions:
  - "registerType: 'prompt' chosen over 'autoUpdate' — prevents SW reload interrupting onboarding form UX"
  - "Separate maskable icon entry (512x512 purpose='maskable') instead of combined 'any maskable' per web.dev best practice"
  - "offline.html navigates to /#/ (not /) for HashRouter compatibility on GitHub Pages"
  - "globPatterns includes html to prevent WorkboxError: non-precached-url for navigation fallback"
  - "networkTimeoutSeconds: 10 for TMDB/OMDB APIs — falls back to cache on slow connections"
  - "devOptions.enabled: true allows service worker testing in Vite dev mode without separate build"

patterns-established:
  - "Pattern: PWA icons live in public/favicon_io/ — Vite copies to dist/ and manifest paths resolve at root"
  - "Pattern: offline.html must be self-contained (no React/JS imports) — it serves when main bundle unavailable"

requirements-completed: [PWA-01, PWA-02, PWA-05, PWA-06]

# Metrics
duration: 5min
completed: 2026-02-18
---

# Phase 4 Plan 01: PWA Infrastructure Foundation Summary

**Workbox service worker with NetworkFirst TMDB/OMDB caching + CacheFirst image caching, web app manifest with maskable icons, and HashRouter-aware offline fallback page**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-18T00:00:00Z
- **Completed:** 2026-02-18T00:05:00Z
- **Tasks:** 2
- **Files modified:** 11

## Accomplishments

- Installed vite-plugin-pwa and configured VitePWA plugin with full Workbox runtimeCaching rules for TMDB API (NetworkFirst, 24h TTL, 200 entries), OMDB API (NetworkFirst, 7-day TTL, 100 entries), and TMDB images (CacheFirst, 30-day TTL, 500 entries)
- Configured web app manifest with correct name, short_name, standalone display, and three icon entries (192x192, 512x512 any, 512x512 maskable as separate entry)
- Created self-contained offline.html with HashRouter-aware navigation (redirects to /#/ not /) and periodic connection checking
- Copied all 6 PWA icons from assets/favicon_io to public/favicon_io so Vite copies them to dist/ and manifest icon paths resolve correctly
- Build produces dist/sw.js (Workbox service worker), dist/manifest.webmanifest, dist/offline.html, and dist/favicon_io/ with all 6 icons

## Task Commits

Each task was committed atomically:

1. **Task 1: Install vite-plugin-pwa and configure service worker + manifest** - `410ee76` (feat)
2. **Task 2: Copy icons to public/, create offline.html, update index.html icon refs** - `56120cd` (feat)

## Files Created/Modified

- `vite.config.ts` - Added VitePWA plugin with manifest, workbox config, runtimeCaching (3 strategies)
- `src/vite-env.d.ts` - Added `/// <reference types="vite-plugin-pwa/react" />` for PWA virtual module types
- `index.html` - Updated icon hrefs from `/assets/favicon_io/` to `/favicon_io/` (public/ root path)
- `package.json` - Added vite-plugin-pwa to devDependencies
- `public/offline.html` - Self-contained offline fallback, HashRouter-aware, no site.webmanifest ref
- `public/favicon_io/android-chrome-192x192.png` - PWA icon 192x192
- `public/favicon_io/android-chrome-512x512.png` - PWA icon 512x512 (used for both any + maskable)
- `public/favicon_io/apple-touch-icon.png` - Apple touch icon
- `public/favicon_io/favicon.ico` - Browser favicon
- `public/favicon_io/favicon-16x16.png` - Small favicon
- `public/favicon_io/favicon-32x32.png` - Standard favicon

## Decisions Made

- Used `registerType: 'prompt'` over `'autoUpdate'` — the onboarding wizard (Phase 03) would be interrupted by an automatic page reload triggered by a SW update
- Separate maskable icon entry rather than `purpose: 'any maskable'` per web.dev guidance — combining these produces a single bitmap that may not be correctly masked by OS
- offline.html redirects to `/#/` (HashRouter hash prefix) so the React app initializes correctly on GitHub Pages
- `globPatterns` includes `html` files — prevents Workbox from throwing `non-precached-url` error when navigateFallback serves offline.html on uncached navigation

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

Node v18 engine warning from workbox-build (requires >=20) — non-fatal, install and build succeed. This is a transitive dependency of vite-plugin-pwa. Build output is correct.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Service worker infrastructure complete and verified with npm run build (28 precached entries)
- dist/sw.js and dist/manifest.webmanifest confirmed in output
- Plan 04-02 can now implement install prompts (useInstallPrompt hook) and update notifications using the BeforeInstallPromptEvent and SW update lifecycle that registerType: 'prompt' exposes

---
*Phase: 04-pwa-infrastructure*
*Completed: 2026-02-18*
