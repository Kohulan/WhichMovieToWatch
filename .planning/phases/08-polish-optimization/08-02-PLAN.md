---
phase: 08-polish-optimization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/movie/MovieHero.tsx
  - src/components/movie/RatingBadges.tsx
  - src/components/trending/TrendingPage.tsx
  - src/components/bento/cells/DiscoverHeroCell.tsx
  - src/components/bento/cells/TrendingPreviewCell.tsx
  - src/hooks/useResponsiveImage.ts
  - vite.config.ts
autonomous: true
requirements:
  - PERF-02
  - PERF-03
  - PERF-05

must_haves:
  truths:
    - "TMDB poster images load with responsive srcset (w185/w342/w500/w780) selecting appropriate size per viewport"
    - "All poster images use loading=lazy and decoding=async attributes"
    - "Main bundle (excluding lazy-loaded 3D chunks) is under 500KB gzipped"
    - "API responses are cached via IndexedDB + Workbox runtime caching, repeat visits load from cache"
    - "TMDB does not serve WebP natively; responsive srcset is the correct PERF-02 implementation per research"
  artifacts:
    - path: "src/hooks/useResponsiveImage.ts"
      provides: "Responsive TMDB image URL builder with srcset generation"
      contains: "srcSet"
    - path: "vite.config.ts"
      provides: "Build configuration with chunk optimization"
      contains: "manualChunks"
  key_links:
    - from: "src/components/movie/MovieHero.tsx"
      to: "src/hooks/useResponsiveImage.ts"
      via: "import and usage of responsive image helper"
      pattern: "useResponsiveImage|buildSrcSet|tmdbSrcSet"
---

<objective>
Optimize image loading with responsive srcset for TMDB posters, verify bundle size under 500KB gzipped (excluding 3D), and confirm API caching is effective.

Purpose: Meet PERF-02 (image optimization), PERF-03 (bundle size), and PERF-05 (API caching) requirements. TMDB does not serve WebP, so focus is on responsive srcset with multiple resolution sizes and lazy loading. Bundle size verification requires a clean build. API caching is already implemented via IndexedDB + Workbox; this plan verifies and tunes it.

Output: Responsive poster images across all components, verified sub-500KB bundle, confirmed API caching behavior.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-polish-optimization/08-RESEARCH.md
@src/components/movie/MovieHero.tsx
@vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add responsive srcset to all TMDB poster/backdrop images</name>
  <files>
    src/hooks/useResponsiveImage.ts
    src/components/movie/MovieHero.tsx
    src/components/trending/TrendingPage.tsx
    src/components/bento/cells/DiscoverHeroCell.tsx
    src/components/bento/cells/TrendingPreviewCell.tsx
  </files>
  <action>
    Create a reusable responsive image utility and apply it to all TMDB image components.

    1. **Create `src/hooks/useResponsiveImage.ts`:**
       - Export a `tmdbImageUrl(path: string, size: string): string` helper that builds `https://image.tmdb.org/t/p/${size}${path}`.
       - Export a `tmdbPosterSrcSet(path: string): string` that returns a srcSet string: `"https://image.tmdb.org/t/p/w185${path} 185w, https://image.tmdb.org/t/p/w342${path} 342w, https://image.tmdb.org/t/p/w500${path} 500w, https://image.tmdb.org/t/p/w780${path} 780w"`.
       - Export a `tmdbBackdropSrcSet(path: string): string` for backdrop images: `w300 300w, w780 780w, w1280 1280w`.
       - Export a `posterSizes` constant: `"(max-width: 640px) 185px, (max-width: 1024px) 342px, 500px"`.
       - Export a `backdropSizes` constant: `"(max-width: 640px) 300px, (max-width: 1024px) 780px, 1280px"`.
       - These are pure utility functions, NOT React hooks (no state, no effects). File name starts with `use` per codebase convention but they are plain exports.

    2. **Update MovieHero.tsx:**
       - Import `tmdbPosterSrcSet`, `tmdbBackdropSrcSet`, `posterSizes`, `backdropSizes` from the new utility.
       - On the backdrop `<img>`: add `srcSet={tmdbBackdropSrcSet(movie.backdrop_path)}`, `sizes={backdropSizes}`, `loading="lazy"`, `decoding="async"`.
       - On the poster `<img>`: add `srcSet={tmdbPosterSrcSet(movie.poster_path)}`, `sizes={posterSizes}`, `loading="lazy"`, `decoding="async"`.
       - Keep the existing `src` as fallback (w500 for poster, w1280 for backdrop).

    3. **Update TrendingPage.tsx:**
       - On trending movie poster images: add `srcSet` and `sizes` using poster helpers. Add `loading="lazy"` and `decoding="async"`.

    4. **Update DiscoverHeroCell.tsx and TrendingPreviewCell.tsx:**
       - If these cells render TMDB images (posters or backdrops), add srcSet/sizes. Use backdrop helpers for backdrop images, poster helpers for poster thumbnails.

    5. **Scan all other components with TMDB image URLs:**
       - Search for `image.tmdb.org` across all `src/` files. For any component rendering TMDB poster/backdrop images without srcSet, add the appropriate srcSet and sizes attributes.
       - Ensure all TMDB images have `loading="lazy"` and `decoding="async"`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes.
    - Open browser DevTools Network tab, filter by Images. Load the Discovery page — verify poster images load at appropriate resolution for viewport width (e.g., w342 on mobile, w500 on desktop).
    - Check that `srcset` attribute is present in DOM for poster images.
  </verify>
  <done>All TMDB poster and backdrop images across the app use responsive srcset with w185/w342/w500/w780 sizes, loading=lazy, and decoding=async. A shared utility provides consistent image URL generation.</done>
</task>

<task type="auto">
  <name>Task 2: Verify bundle size and API caching effectiveness</name>
  <files>
    vite.config.ts
  </files>
  <action>
    Verify the main bundle (excluding lazy-loaded 3D) is under 500KB gzipped and confirm API caching works.

    1. **Fix any TypeScript errors preventing build:**
       - Run `npx tsc --noEmit` first. If errors exist in DinnerTimePage.tsx, AppShell.tsx, or other files (noted in research as pre-existing), fix them. These are likely type mismatches from Phase 7 uncommitted changes.
       - Common fixes: import type adjustments, optional chaining for nullable values, type narrowing.

    2. **Run production build and analyze:**
       - Run `npm run build` and capture the output.
       - Examine the Vite build output to see chunk sizes. Sum all chunks EXCEPT `spline-vendor-*.js`, `SplineHero-*.js`, and `gpu-detect-*.js` (these are lazy-loaded 3D and excluded per PERF-03 scope).
       - The sum of remaining chunks (gzipped) must be under 500KB.
       - If over 500KB: check if any unexpected large dependency slipped in. Consider splitting large page components into lazy routes. Check if `three-vendor` chunk is being created (it should not be — the project uses Spline, not raw Three.js).

    3. **Verify API caching:**
       - Review vite.config.ts Workbox runtimeCaching entries:
         - TMDB API: NetworkFirst with 200 entries, 24h TTL, 10s timeout -> correct
         - OMDB API: NetworkFirst with 100 entries, 7-day TTL, 10s timeout -> correct
         - TMDB Images: CacheFirst with 500 entries, 30-day TTL -> correct
       - Review IndexedDB TTL caching in `src/services/cache-manager.ts` — confirm it uses stale-while-revalidate pattern with appropriate TTLs.
       - No changes expected here — just verify the dual-layer caching (IndexedDB for API service layer + Workbox for SW layer) is correctly configured. Document verification in summary.

    4. **Bundle optimization (if needed):**
       - If bundle is over 500KB, check `vite.config.ts` manualChunks for missed optimization opportunities.
       - Consider adding `rollup-plugin-visualizer` temporarily: `import { visualizer } from 'rollup-plugin-visualizer'` and add to plugins array with `open: true` to identify large modules.
       - Remove the visualizer after analysis (do not commit it).
  </action>
  <verify>
    - `npm run build` completes without errors.
    - Sum gzipped sizes of non-3D chunks is under 500KB.
    - Workbox runtime caching entries cover TMDB API, OMDB API, and TMDB images.
  </verify>
  <done>Production build succeeds. Main bundle (excluding lazy-loaded 3D) is verified under 500KB gzipped. API caching via IndexedDB + Workbox runtime caching is confirmed effective with appropriate TTLs.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors.
2. Vite build output shows chunk sizes — sum of non-3D chunks under 500KB gzipped.
3. Browser Network tab shows appropriate srcset image resolution selected per viewport.
4. All TMDB images have `srcset`, `sizes`, `loading="lazy"`, `decoding="async"` attributes.
5. `npx tsc --noEmit` passes.
</verification>

<success_criteria>
- All TMDB images use responsive srcset with multiple sizes
- Main bundle under 500KB gzipped (excluding 3D lazy chunks)
- Production build succeeds cleanly
- API caching confirmed via IndexedDB + Workbox dual-layer strategy
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-optimization/08-02-SUMMARY.md`
</output>
