---
phase: 08-polish-optimization
plan: 04
type: execute
wave: 2
depends_on:
  - "08-01"
  - "08-02"
  - "08-03"
files_modified:
  - index.html
  - src/main.tsx
  - src/App.tsx
  - src/pages/PrivacyPage.tsx
  - src/components/layout/TabBar.tsx
autonomous: true
requirements:
  - PRIV-01
  - PRIV-02
  - SECU-01

must_haves:
  truths:
    - "Privacy policy page is accessible at /#/privacy route with full privacy policy content"
    - "Footer privacy link navigates to the React privacy route (not privacy.html)"
    - "Simple Analytics tracks page views with hash mode for HashRouter"
    - "Content Security Policy meta tag blocks unsafe scripts and restricts resource loading to trusted domains"
    - "CSP meta tag is placed AFTER the inline FOUC prevention script in index.html"
  artifacts:
    - path: "src/pages/PrivacyPage.tsx"
      provides: "Full privacy policy page with content from existing privacy.html"
      contains: "Privacy Policy"
    - path: "index.html"
      provides: "CSP meta tag restricting resources to trusted domains"
      contains: "Content-Security-Policy"
    - path: "src/App.tsx"
      provides: "Simple Analytics integration for page view tracking"
      contains: "simpleanalytics"
  key_links:
    - from: "src/components/layout/TabBar.tsx"
      to: "src/pages/PrivacyPage.tsx"
      via: "Link component navigation to /privacy route"
      pattern: "privacy"
    - from: "src/main.tsx"
      to: "src/pages/PrivacyPage.tsx"
      via: "Route definition in createHashRouter"
      pattern: "privacy.*PrivacyPage"
    - from: "index.html"
      to: "scripts.simpleanalyticscdn.com"
      via: "CSP script-src allowlist"
      pattern: "simpleanalyticscdn"
---

<objective>
Add privacy policy page, Simple Analytics integration, and Content Security Policy headers.

Purpose: Complete the privacy, analytics, and security requirements (PRIV-01, PRIV-02, SECU-01). The privacy policy gets a dedicated React route at /privacy. Simple Analytics provides cookieless, GDPR-compliant page view tracking. CSP via meta tag restricts resource loading to trusted domains.

Output: /privacy route with policy content, Simple Analytics tracking hash-based navigation, CSP meta tag blocking untrusted sources.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-polish-optimization/08-RESEARCH.md
@index.html
@src/main.tsx
@src/App.tsx
@src/components/layout/TabBar.tsx
@privacy.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create privacy policy page and Simple Analytics integration</name>
  <files>
    src/pages/PrivacyPage.tsx
    src/main.tsx
    src/App.tsx
    src/components/layout/TabBar.tsx
  </files>
  <action>
    Build the privacy policy page, integrate Simple Analytics, and update footer link.

    1. **Create `src/pages/PrivacyPage.tsx`:**
       - Per user decision: **Dedicated route** at `/privacy` — full page, not a modal.
       - Reference existing `privacy.html` for content structure and text.
       - Render a full-page layout with clay-styled container:
         - Max width container (`max-w-3xl mx-auto px-4 py-8`).
         - `<h1>` "Privacy Policy" in Righteous font (heading font).
         - Effective date paragraph.
         - Sections covering:
           - **Data Collection**: The app does not collect personal data. No accounts, no authentication. All preferences stored locally in browser localStorage.
           - **Third-Party Services**: TMDB API (movie data), OMDB API (ratings), IPInfo (geolocation), Simple Analytics (anonymous page views).
           - **Analytics**: Simple Analytics is used for anonymous, cookieless page view tracking. No personal information is collected. No cookies are set. Data cannot be traced to individual users. See simpleanalytics.com for their privacy policy.
           - **Cookies**: This app does not use cookies. LocalStorage is used for user preferences only and never transmitted to any server.
           - **Third-Party Links**: The app links to streaming services (Netflix, Disney+, Amazon Prime, etc.), YouTube, and other external sites. We are not responsible for their privacy practices.
           - **Children's Privacy**: The app does not knowingly collect data from children.
           - **Changes**: Policy may be updated. Changes will be reflected on this page.
           - **Contact**: Link to GitHub repository for questions.
         - Each section: `<h2>` heading + `<p>` body text. Style with `text-clay-text` for body, `text-clay-text-muted` for secondary text.
         - Back link at bottom: link to home page using react-router `Link`.
       - Export as default for lazy loading potential (or named export).

    2. **Add route in `src/main.tsx`:**
       - Import `PrivacyPage` (can use React.lazy for code splitting if desired, but the page is small so direct import is fine).
       - Add route: `{ path: 'privacy', element: <PrivacyPage /> }` inside the children array of the root route.

    3. **Update footer link in `src/components/layout/TabBar.tsx`:**
       - Per user decision: **Update existing footer link** to point to the new `/privacy` route.
       - Change the privacy link from `<a href="/privacy.html">` to use react-router `Link` component: `<Link to="/privacy">Privacy</Link>`.
       - Import `Link` from `react-router`.
       - Preserve existing styling classes on the link.

    4. **Integrate Simple Analytics in `src/App.tsx`:**
       - Per user decision: **Page views only** — minimal tracking, no event tracking.
       - Per user decision: No consent banner needed (Simple Analytics is cookieless).
       - First, try using `@simpleanalytics/react` package. Install it: the package should already be planned for installation.
       - If `@simpleanalytics/react` does NOT support `mode="hash"` as a prop (check the package source after install):
         - Fall back to a manual script tag approach. In App.tsx, use a `useEffect` that runs once to inject the Simple Analytics script:
           ```
           const script = document.createElement('script');
           script.src = 'https://scripts.simpleanalyticscdn.com/latest.js';
           script.async = true;
           script.defer = true;
           script.dataset.mode = 'hash';
           document.body.appendChild(script);
           ```
         - Also add noscript pixel: create an `<img>` element with `src="https://queue.simpleanalyticscdn.com/noscript.gif"` and append to body.
       - If the React component DOES support hash mode: `<SimpleAnalytics mode="hash" />` in App.tsx, rendered once outside of any conditional.
       - The analytics should load regardless of splash screen state — place it outside the splash guard.
       - **Important:** Install the package first: `npm install @simpleanalytics/react`. If the package doesn't exist or has issues, use the manual script approach.
  </action>
  <verify>
    - Navigate to `/#/privacy` — privacy policy page renders with all sections.
    - Footer "Privacy" link navigates to `/#/privacy` (not privacy.html).
    - Browser Network tab shows request to `scripts.simpleanalyticscdn.com/latest.js`.
    - Check browser console for Simple Analytics initialization messages.
    - Navigate between routes — verify hash changes are tracked (check Simple Analytics dashboard if accessible, or verify script loads with `data-mode="hash"` attribute in DOM).
    - `npx tsc --noEmit` passes.
  </verify>
  <done>Privacy policy page renders at /#/privacy with comprehensive policy content. Footer link updated to React route. Simple Analytics tracks page views with hash mode for HashRouter navigation.</done>
</task>

<task type="auto">
  <name>Task 2: Add Content Security Policy meta tag</name>
  <files>
    index.html
  </files>
  <action>
    Add CSP meta tag to index.html to restrict resource loading to trusted domains.

    Per user decision and research: Stay on GitHub Pages with meta-tag CSP.

    1. **Add CSP meta tag in `index.html`:**
       - Place the `<meta http-equiv="Content-Security-Policy">` tag AFTER the inline FOUC prevention script. This is critical — per research Pitfall 2, meta-tag CSP only applies to content after it in the document, so the FOUC script (which appears before) is not blocked.
       - Place it right after the closing `</script>` tag of the FOUC prevention script and before the closing `</head>`.
       - CSP content value (all on one line in the content attribute):
         ```
         default-src 'self';
         script-src 'self' https://scripts.simpleanalyticscdn.com;
         style-src 'self' 'unsafe-inline';
         img-src 'self' https://image.tmdb.org data: blob: https://*.simpleanalyticscdn.com;
         font-src 'self';
         connect-src 'self' https://api.themoviedb.org https://www.omdbapi.com https://ipinfo.io https://corsproxy.io https://queue.simpleanalyticscdn.com https://prod.spline.design;
         media-src 'self';
         frame-src 'none';
         object-src 'none';
         base-uri 'self';
         ```
       - Notes on each directive:
         - `script-src 'self'`: No `unsafe-inline` needed — FOUC script is before CSP tag. Vite modules load as `type="module"`. Simple Analytics CDN explicitly allowed.
         - `style-src 'unsafe-inline'`: Required because Tailwind v4 and Framer Motion inject inline styles at runtime.
         - `img-src data: blob:`: `data:` for SVG textures (clay-texture feTurbulence), `blob:` for story card canvas export.
         - `connect-src`: All external APIs the app communicates with.
         - `frame-src 'none'`: App doesn't use iframes.
         - `object-src 'none'`: Blocks Flash/Java/etc.

    2. **Verify CSP doesn't break existing functionality:**
       - After adding CSP, test:
         - Theme toggle works (FOUC script runs before CSP).
         - Movie posters load (image.tmdb.org in img-src).
         - API calls work (api.themoviedb.org, www.omdbapi.com, ipinfo.io in connect-src).
         - Story card generation works (corsproxy.io in connect-src, blob: in img-src).
         - 3D scene loads on capable devices (prod.spline.design in connect-src).
         - Simple Analytics script loads (scripts.simpleanalyticscdn.com in script-src).
         - Clay textures render (data: in img-src for SVG data URIs).
       - Check browser console for any CSP violation errors. If Spline runtime needs additional CSP relaxation (e.g., `wasm-unsafe-eval`), add it narrowly scoped. Document any additions.
  </action>
  <verify>
    - View page source — CSP meta tag present after FOUC script, before `</head>`.
    - Browser console shows no CSP violation errors during normal app usage.
    - All external resources load correctly (images, APIs, analytics, 3D scene).
    - Theme toggle works on page load (FOUC script not blocked).
    - `npx tsc --noEmit` passes (no TS changes, but confirm nothing else broke).
  </verify>
  <done>CSP meta tag in index.html restricts scripts to self + Simple Analytics CDN, styles allow inline (Tailwind/Motion), images from TMDB + data/blob, connections to all required API domains. No CSP violations in normal usage.</done>
</task>

</tasks>

<verification>
1. Navigate to `/#/privacy` — full privacy policy page renders correctly.
2. Footer "Privacy" link routes to `/#/privacy` within the SPA.
3. Simple Analytics script loads with `data-mode="hash"`.
4. CSP meta tag present in index.html after FOUC script.
5. No CSP violation errors in browser console during full app walkthrough.
6. All external resources (TMDB images, APIs, Spline 3D, analytics) load correctly with CSP active.
7. `npx tsc --noEmit` passes.
</verification>

<success_criteria>
- Privacy policy page accessible at /privacy with comprehensive content (PRIV-01)
- Simple Analytics tracking page views with hash mode (PRIV-02)
- CSP meta tag restricting resources to trusted domains (SECU-01)
- No functionality broken by CSP
- Footer privacy link updated to React route
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-optimization/08-04-SUMMARY.md`
</output>
