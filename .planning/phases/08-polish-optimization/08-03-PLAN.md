---
phase: 08-polish-optimization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/share/StoryCardGenerator.ts
  - src/components/share/ShareButton.tsx
  - src/components/share/ShareMenu.tsx
  - src/components/share/MovieMetaTags.tsx
  - src/hooks/useShare.ts
  - src/components/discovery/DiscoveryPage.tsx
autonomous: true
requirements:
  - SOCL-01
  - SOCL-02
  - SOCL-03
  - SOCL-04

must_haves:
  truths:
    - "User can generate a 1080x1920 Instagram story card with movie poster, title, rating, and theme-aware branding"
    - "User can download the story card as a PNG image"
    - "Floating share button appears on Discovery page when a movie is loaded"
    - "Mobile users see native OS share sheet via Web Share API; desktop users see custom share menu with copy link, story card, Twitter/X, WhatsApp options"
    - "Dynamic OG and Twitter Card meta tags update when viewing a movie on Discovery page"
  artifacts:
    - path: "src/components/share/StoryCardGenerator.ts"
      provides: "Canvas-based story card generation with CORS proxy for TMDB posters"
      contains: "corsproxy.io"
    - path: "src/components/share/ShareButton.tsx"
      provides: "Floating share FAB with Web Share API detection"
      contains: "navigator.share"
    - path: "src/components/share/ShareMenu.tsx"
      provides: "Desktop fallback share menu with copy link, story card, Twitter/X, WhatsApp"
      contains: "ShareMenu"
    - path: "src/components/share/MovieMetaTags.tsx"
      provides: "React 19 native meta tag hoisting for OG and Twitter Card"
      contains: "og:title"
    - path: "src/hooks/useShare.ts"
      provides: "Web Share API hook with native share detection and fallback"
      contains: "canNativeShare"
  key_links:
    - from: "src/components/discovery/DiscoveryPage.tsx"
      to: "src/components/share/ShareButton.tsx"
      via: "ShareButton rendered when currentMovie is loaded"
      pattern: "ShareButton"
    - from: "src/components/share/ShareButton.tsx"
      to: "src/hooks/useShare.ts"
      via: "useShare hook for native share detection"
      pattern: "useShare"
    - from: "src/components/share/ShareButton.tsx"
      to: "src/components/share/StoryCardGenerator.ts"
      via: "generateStoryCard called from share menu"
      pattern: "generateStoryCard"
---

<objective>
Implement social sharing: Instagram story card generator, floating share button with Web Share API fallback, and dynamic OG/Twitter Card meta tags.

Purpose: Enable users to share movie discoveries via Instagram stories, Twitter/X, WhatsApp, and link copying (SOCL-01 through SOCL-04). The story card uses canvas-based generation matching the existing `scripts/story-card.js` pattern. Meta tags use React 19 native metadata hoisting (client-side only, accepted SPA limitation).

Output: Floating share button on Discovery page, story card download, native share on mobile, custom share menu on desktop, dynamic OG/Twitter meta tags.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-polish-optimization/08-RESEARCH.md
@scripts/story-card.js
@src/stores/themeStore.ts
@src/components/discovery/DiscoveryPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create story card generator and share hooks</name>
  <files>
    src/components/share/StoryCardGenerator.ts
    src/hooks/useShare.ts
    src/components/share/MovieMetaTags.tsx
  </files>
  <action>
    Build the story card generator, share hook, and meta tag component.

    1. **Create `src/components/share/StoryCardGenerator.ts`** (pure TypeScript, no React):
       - Reference `scripts/story-card.js` for the proven canvas + CORS proxy approach.
       - Per user decision: **Movie poster dominant** layout — large poster image with title, rating, app branding at bottom.
       - Per user decision: **Theme-aware** — gradient and accent colors match current theme preset.
       - Define interface `StoryCardMovie` with: `title: string`, `poster_path: string | null`, `vote_average: number`, `release_date: string`, `genres?: Array<{ id: number; name: string }>`, `id: number`.
       - Import `ColorPreset` type from `@/stores/themeStore`.
       - Define `THEME_GRADIENTS: Record<ColorPreset, { dark: [string, string], light: [string, string] }>` mapping each preset to dark and light gradient color pairs. Use colors inspired by the existing oklch theme values in `app.css`:
         - `warm-orange` dark: `['#1f150d', '#2d1810']`, light: `['#f5e6d3', '#f0d4b8']` (oklch hue ~60, warm cinematic tones)
         - `gold` dark: `['#1c1508', '#2a1f0d']`, light: `['#f5ecd3', '#ede0b8']` (oklch hue ~65-75, rich luxury gold tones)
         - `clean-white` dark: `['#0f1118', '#161a24']`, light: `['#f0f2f5', '#e4e8ee']` (oklch hue ~250, cool neutral crisp tones)
       - Export `async function generateStoryCard(movie: StoryCardMovie, preset: ColorPreset, mode: 'light' | 'dark'): Promise<Blob | null>`:
         - Create canvas 1080x1920.
         - Draw gradient background using preset's mode-specific colors.
         - Add subtle star pattern overlay (same as story-card.js random dots, globalAlpha 0.1).
         - Load poster via CORS proxy: `https://corsproxy.io/?${encodeURIComponent(`https://image.tmdb.org/t/p/w780${movie.poster_path}`)}` with `img.crossOrigin = 'anonymous'`.
         - Draw poster centered at top (800w x 1200h, rounded corners 20px, shadow). If poster fails, draw gradient placeholder with title text.
         - Below poster: year and star rating centered (`${year} - ★ ${vote_average.toFixed(1)}`).
         - Below that: up to 3 genre names joined by bullet.
         - Bottom section: "whichmovieto.watch" link text in accent color, then "Which Movie To Watch" brand name.
         - Use font stack: `'Poppins, sans-serif'` for body text, `'Righteous, sans-serif'` for brand name (matching app fonts). Note: canvas may not have these fonts — use `'Arial, sans-serif'` as fallback since canvas font loading is complex and not worth the overhead.
         - Return `canvas.toBlob()` as PNG via Promise wrapper.
       - Export `function downloadStoryCard(blob: Blob, movieTitle: string): void`:
         - Create object URL, create `<a>` element, set download filename as `${movieTitle.replace(/\s+/g, '-').toLowerCase()}-story.png`, click, cleanup.

    2. **Create `src/hooks/useShare.ts`:**
       - Export `function useShare()`:
         - `canNativeShare`: `typeof navigator !== 'undefined' && !!navigator.share` — boolean.
         - `share(data: { title: string; text: string; url: string }): Promise<boolean>` — attempts `navigator.share(data)`, returns true if successful, false if cancelled or API unavailable. Catches AbortError silently (user cancelled).
         - `copyToClipboard(text: string): Promise<boolean>` — uses `navigator.clipboard.writeText(text)`, returns true on success, false on error.
         - Return `{ canNativeShare, share, copyToClipboard }`.

    3. **Create `src/components/share/MovieMetaTags.tsx`:**
       - Per user decision: Use React 19 native metadata hoisting (no react-helmet).
       - Export `function MovieMetaTags({ movie }: { movie: { id: number; title: string; overview?: string; poster_path?: string | null; release_date?: string } })`:
         - Compute `posterUrl`: if `movie.poster_path`, use `https://image.tmdb.org/t/p/w1280${movie.poster_path}`, else `/assets/images/preview.png` or a fallback.
         - Compute `pageUrl`: `https://www.whichmovieto.watch/#/discover?movie=${movie.id}`.
         - Compute `description`: `${movie.title} (${movie.release_date?.slice(0, 4) || ''}) - ${movie.overview?.slice(0, 150) || 'Discover this movie'}...`.
         - Return JSX fragment with React 19 `<title>`, `<meta>` tags:
           - `<title>{movie.title} - Which Movie To Watch</title>`
           - OG tags: `og:title`, `og:description`, `og:image`, `og:url`, `og:type` (value: "video.movie")
           - Twitter tags: `twitter:card` (value: "summary_large_image"), `twitter:title`, `twitter:description`, `twitter:image`
         - Note: these are client-side only. Social media crawlers will NOT see them. This is an accepted SPA limitation documented in research.
  </action>
  <verify>
    - `npx tsc --noEmit` passes.
    - Story card generator function signature is correct and exports are accessible.
  </verify>
  <done>StoryCardGenerator produces 1080x1920 PNG with poster, title, rating, and theme-aware branding. useShare hook detects Web Share API. MovieMetaTags renders OG/Twitter meta tags via React 19 hoisting.</done>
</task>

<task type="auto">
  <name>Task 2: Create share UI and integrate into Discovery page</name>
  <files>
    src/components/share/ShareButton.tsx
    src/components/share/ShareMenu.tsx
    src/components/discovery/DiscoveryPage.tsx
  </files>
  <action>
    Build the floating share button, desktop share menu, and wire into Discovery page.

    1. **Create `src/components/share/ShareMenu.tsx`:**
       - Per user decision: Desktop fallback menu with copy link, Instagram story, Twitter/X, WhatsApp.
       - Props: `movie: StoryCardMovie`, `onClose: () => void`.
       - Import `generateStoryCard`, `downloadStoryCard` from StoryCardGenerator.
       - Import `useShare` from hooks.
       - Import `useThemeStore` to get current `preset` and `mode` for theme-aware story card.
       - Render a `motion.div` overlay with backdrop click to close.
       - Inner panel: clay-styled card (use `bg-clay-surface` + rounded corners + shadow) with 4 action rows:
         - **Copy Link** (Link icon from lucide-react): calls `copyToClipboard(shareUrl)`, shows toast "Link copied!".
         - **Instagram Story** (Download icon): calls `generateStoryCard(movie, preset, mode)`, then `downloadStoryCard(blob, movie.title)`, shows toast "Story card downloaded! Share it on Instagram."
         - **Twitter/X** (external link): opens `https://twitter.com/intent/tweet?text=${encodeURIComponent(`Check out ${movie.title} on Which Movie To Watch!`)}&url=${encodeURIComponent(shareUrl)}` in new tab.
         - **WhatsApp** (external link): opens `https://wa.me/?text=${encodeURIComponent(`Check out ${movie.title}! ${shareUrl}`)}` in new tab.
       - Each row: icon + label, hover highlight, keyboard accessible (button elements).
       - AnimatePresence entrance: slide up + fade from bottom.
       - Escape key closes menu.
       - ARIA: `role="dialog"`, `aria-label="Share movie"`, focus trap inside menu.

    2. **Create `src/components/share/ShareButton.tsx`:**
       - Per user decision: **Floating share button** — fixed position, opens share sheet.
       - Per Claude's discretion (research): Show only on Discovery page when movie is loaded.
       - Props: `movie: StoryCardMovie`.
       - Import `useShare` hook.
       - Import `ShareMenu` component.
       - State: `menuOpen: boolean`.
       - On click:
         - If `canNativeShare`: call `share({ title: movie.title, text: `Check out ${movie.title}!`, url: shareUrl })`. If returns false (failed/unsupported), open custom menu.
         - If not `canNativeShare`: open custom menu (`setMenuOpen(true)`).
       - Render `motion.button` with: `className="fixed bottom-24 right-4 z-30 w-12 h-12 rounded-full shadow-lg flex items-center justify-center"`. Style with clay/accent background matching the theme.
       - `whileHover={{ scale: 1.1 }}`, `whileTap={{ scale: 0.9 }}`.
       - `aria-label="Share this movie"`.
       - Icon: `Share2` from lucide-react, w-5 h-5.
       - Render `AnimatePresence` with `ShareMenu` when `menuOpen` is true.
       - Position: bottom-24 right-4 places it above the footer TabBar but below the main content area.

    3. **Integrate into DiscoveryPage.tsx:**
       - Import `ShareButton` and `MovieMetaTags`.
       - When `currentMovie` is loaded and non-null:
         - Render `<MovieMetaTags movie={currentMovie} />` inside the component JSX (React 19 hoists to head).
         - Render `<ShareButton movie={currentMovie} />` — the floating button appears.
       - When no movie is loaded (loading state), neither component renders.
       - Pass the movie object with the required fields (title, poster_path, vote_average, release_date, genres, id).
  </action>
  <verify>
    - `npx tsc --noEmit` passes.
    - Load Discovery page with a movie — floating share button visible at bottom-right.
    - Click share button on desktop — custom share menu appears with 4 options.
    - Click "Copy Link" — link copied to clipboard (verify with paste).
    - Click "Instagram Story" — PNG file downloads with movie poster and branding.
    - Click "Twitter/X" — new tab opens with pre-filled tweet.
    - Click "WhatsApp" — new tab opens with pre-filled WhatsApp message.
    - Press Escape — share menu closes.
    - On mobile (or mobile emulation with navigator.share available): share button triggers native share sheet.
    - Inspect `<head>` — verify OG and Twitter meta tags are present when a movie is loaded.
  </verify>
  <done>Floating share button renders on Discovery page when movie is loaded. Native share on mobile, custom menu on desktop with copy link, story card download, Twitter/X, and WhatsApp options. OG/Twitter Card meta tags update dynamically per movie.</done>
</task>

</tasks>

<verification>
1. Discovery page shows floating share button when a movie is loaded.
2. Share button not visible on Home, Trending, Dinner Time, Free Movies pages.
3. Desktop: click share -> custom menu with 4 options. Each option works.
4. Mobile: click share -> native OS share sheet.
5. Story card downloads as 1080x1920 PNG with correct poster, title, rating, and theme-aware colors.
6. Browser `<head>` contains og:title, og:image, twitter:card meta tags matching current movie.
7. `npx tsc --noEmit` passes.
</verification>

<success_criteria>
- Instagram story card generates correctly with poster, title, rating, and theme branding (SOCL-01)
- OG meta tags rendered in head per movie (SOCL-02)
- Twitter Card meta tags rendered in head per movie (SOCL-03)
- Share button with native + desktop fallback options (SOCL-04)
- All share options functional (copy, download, Twitter, WhatsApp)
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-optimization/08-03-SUMMARY.md`
</output>
