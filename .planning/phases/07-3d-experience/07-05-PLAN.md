---
phase: 07-3d-experience
plan: 05
type: execute
wave: 4
depends_on: ["07-03", "07-04"]
files_modified:
  - src/components/3d/SplineScene.tsx
  - src/components/3d/ParallaxFallback.tsx
  - src/components/3d/SplineHero.tsx
  - vite.config.ts
autonomous: false
requirements: [3DXP-07, PERF-04]

must_haves:
  truths:
    - "Lighthouse performance score >= 90 on desktop with 3D loaded"
    - "3D scene does not contribute to CLS (score remains 0)"
    - "Total Blocking Time (TBT) does not regress beyond 200ms on initial load"
    - "Spline runtime is in a separate chunk, not loaded until after LCP"
    - "Mobile devices at 30+ fps with reduced-3d mode"
    - "All 3D features degrade gracefully — no feature breaks if .splinecode is missing or invalid"
    - "Build output shows clean chunk separation: react-vendor, animation-vendor, spline-vendor"
  artifacts:
    - path: "vite.config.ts"
      provides: "Optimized chunk splitting for production"
      contains: "spline-vendor"
    - path: "src/components/3d/SplineScene.tsx"
      provides: "Performance-optimized Spline rendering"
      contains: "renderOnDemand"
  key_links:
    - from: "npm run build"
      to: "dist/assets/"
      via: "Vite build output"
      pattern: "spline-vendor.*\\.js"
---

<objective>
Performance audit and optimization pass to ensure Lighthouse >= 90 on desktop, no CLS regression, and smooth mobile experience. Verify all 3D features degrade gracefully and chunk splitting is correct.

Purpose: PERF-04 (Lighthouse >= 90) is the hardest success criterion. The Spline runtime is inherently heavy (17+ seconds CPU on desktop). This plan ensures the 3D layer is treated as pure progressive enhancement that never degrades the core app experience.

Output: Optimized build with verified Lighthouse score, performance-tuned Spline rendering, and documented optimization decisions.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-3d-experience/07-RESEARCH.md
@.planning/phases/07-3d-experience/07-CONTEXT.md
@.planning/phases/07-3d-experience/07-03-SUMMARY.md
@.planning/phases/07-3d-experience/07-04-SUMMARY.md

@src/components/3d/SplineScene.tsx
@src/components/3d/SplineHero.tsx
@src/components/3d/ParallaxFallback.tsx
@vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Optimize Spline rendering and build output</name>
  <files>
    src/components/3d/SplineScene.tsx
    src/components/3d/SplineHero.tsx
    src/components/3d/ParallaxFallback.tsx
    vite.config.ts
  </files>
  <action>
    1. Optimize `src/components/3d/SplineScene.tsx`:
       - Ensure the Spline canvas uses `renderOnDemand` mode if the @splinetool/react-spline component supports it. Check the component props — if there is a `renderOnDemand` prop, set it to `true`. This prevents continuous 60fps rendering when the scene is idle, saving CPU/battery.
       - If `renderOnDemand` is not a direct prop, check if the `Application` instance (splineApp) has a method to set render mode after load (e.g., `splineApp.setRenderOnDemand(true)` or similar). Apply in the onLoad callback.
       - Add `loading="lazy"` to the Spline container if applicable
       - For `reduced-3d` mode: apply `will-change: transform` to the container for GPU compositing, and consider reducing canvas resolution:
         - Set explicit `width` and `height` style on the canvas container that are 75% of viewport on mobile (CSS transform scale(1.33) to fill visually but render fewer pixels)
       - Ensure `dispose()` is called on the splineApp in the useEffect cleanup to prevent memory leaks:
         ```typescript
         useEffect(() => {
           return () => {
             const app = scene3dStore.getState().splineApp;
             if (app) {
               app.dispose();
               scene3dStore.getState().setSplineApp(null);
             }
           };
         }, []);
         ```
       - Use `requestIdleCallback` (with `setTimeout` fallback) to defer Spline loading until the browser is idle:
         ```typescript
         const [shouldLoad, setShouldLoad] = useState(false);
         useEffect(() => {
           const id = 'requestIdleCallback' in window
             ? requestIdleCallback(() => setShouldLoad(true), { timeout: 3000 })
             : setTimeout(() => setShouldLoad(true), 1000);
           return () => {
             if ('requestIdleCallback' in window) cancelIdleCallback(id as number);
             else clearTimeout(id as ReturnType<typeof setTimeout>);
           };
         }, []);
         ```
         Only render the `<Spline>` component when `shouldLoad` is true. This ensures LCP and TTI are not affected.

    2. Optimize `src/components/3d/ParallaxFallback.tsx`:
       - Ensure all animated elements use `will-change: transform` for GPU compositing
       - Verify CSS animations use `transform` and `opacity` only (compositor-thread animations, no layout triggers)
       - Add `contain: strict` or `contain: layout paint` to the container for rendering isolation

    3. Verify `vite.config.ts` chunk splitting:
       - Ensure `detect-gpu` is NOT in the spline-vendor chunk (it should load early for detection)
       - detect-gpu can go in a separate `gpu-detect` chunk or be left in the main bundle (it's only ~10KB gzipped)
       - Verify no circular chunk dependencies

    4. Run `npm run build` and examine output:
       - Check that spline-vendor chunk exists and is separate
       - Verify spline-vendor is NOT referenced by the initial index.html script tags
       - Note chunk sizes in the SUMMARY for documentation
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds with separate spline-vendor chunk
    - Build output shows spline-vendor is not in the initial load chain
    - SplineScene has cleanup (dispose) in useEffect return
    - requestIdleCallback defers Spline loading
  </verify>
  <done>
    Spline rendering uses renderOnDemand mode, deferred loading via requestIdleCallback, and proper cleanup via dispose(). Build output shows clean chunk separation with spline-vendor isolated from initial bundle. ParallaxFallback uses GPU-composited animations only.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual and performance verification of complete 3D experience</name>
  <files>n/a</files>
  <action>
    Human verifies the complete 3D experience layer: GPU detection, 2D parallax fallback, Spline 3D scene integration, theme-adaptive lighting, mobile gyroscope parallax, camera page transitions, and performance optimizations.

    Steps to verify:
    1. Open http://localhost:5173/ in Chrome desktop
    2. Verify the 3D scene (or parallax fallback) renders as a background layer behind the clay UI
    3. Move mouse around — scene should subtly shift with parallax depth
    4. Navigate between tabs (Home, Trending, Discover, Dinner Time, Free Movies) — observe camera transitions in 3D or smooth fade transitions
    5. Switch theme presets via RotaryDial — 3D lighting should adapt (warm amber, golden, cool white)
    6. Toggle dark/light mode — 3D atmosphere should shift between noir and bright studio
    7. Open Chrome DevTools > Lighthouse audit on desktop — performance score should be >= 90, CLS should be 0 or near 0
    8. Test mobile (Chrome DevTools device emulation) — parallax fallback or reduced 3D should render
    9. Run `npm run build` — spline-vendor chunk exists in dist/assets/
    10. If .splinecode file not yet designed: verify app works gracefully without it
  </action>
  <verify>User visually confirms all 3D features work or degrade gracefully</verify>
  <done>User types "approved" confirming 3D experience meets quality bar, or describes issues to fix</done>
</task>

</tasks>

<verification>
1. `npm run build` produces clean chunk separation
2. Lighthouse desktop performance score >= 90
3. CLS = 0 with 3D scene
4. No memory leaks (dispose called on unmount)
5. All 3D features degrade gracefully without .splinecode
6. Theme sync and camera transitions work or fail gracefully
</verification>

<success_criteria>
- Lighthouse performance >= 90 on desktop (PERF-04)
- Spline runtime never in initial bundle (PERF-01, 3DXP-07)
- No CLS from 3D canvas insertion
- Spline cleanup prevents memory leaks
- Mobile rendering at 30+ fps with reduced-3d optimizations
- Human verification confirms visual quality and performance
</success_criteria>

<output>
After completion, create `.planning/phases/07-3d-experience/07-05-SUMMARY.md`
</output>
