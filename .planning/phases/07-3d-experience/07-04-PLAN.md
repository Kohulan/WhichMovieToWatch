---
phase: 07-3d-experience
plan: 04
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - src/stores/scene3dStore.ts
  - src/components/3d/CameraTransitionManager.tsx
  - src/components/layout/AppShell.tsx
  - src/components/animation/PageTransition.tsx
autonomous: true
requirements: [3DXP-03]

must_haves:
  truths:
    - "Page navigation triggers a 3D camera state transition when 3D is active"
    - "Sibling pages (Trending, Dinner Time, Free Movies) use lateral track camera movement"
    - "Home-to-feature-page transitions use a dolly push camera movement"
    - "Camera transition duration matches Framer Motion page transition (350ms)"
    - "Framer Motion page transitions still work normally when 3D is not active (fallback-2d)"
    - "When 3D is active, Framer Motion exit animation is simplified to avoid competing with camera movement"
  artifacts:
    - path: "src/components/3d/CameraTransitionManager.tsx"
      provides: "Route-watching component that triggers Spline camera transitions"
      exports: ["CameraTransitionManager"]
    - path: "src/components/animation/PageTransition.tsx"
      provides: "Updated variants with 3D-aware mode"
      exports: ["pageVariants", "pageTransition", "pageVariants3D", "pageTransition3D"]
  key_links:
    - from: "src/components/3d/CameraTransitionManager.tsx"
      to: "src/stores/scene3dStore.ts"
      via: "reads splineApp to call transition()"
      pattern: "splineApp"
    - from: "src/components/3d/CameraTransitionManager.tsx"
      to: "react-router"
      via: "useLocation to detect route changes"
      pattern: "useLocation"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/components/3d/CameraTransitionManager.tsx"
      via: "renders CameraTransitionManager when 3D active"
      pattern: "CameraTransitionManager"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/components/animation/PageTransition.tsx"
      via: "selects 3D or standard variants based on capability"
      pattern: "pageVariants3D|pageVariants"
---

<objective>
Implement 3D camera state transitions on page navigation — lateral track for sibling pages, dolly push for hierarchical transitions — synchronized with existing Framer Motion page transitions.

Purpose: Camera movement during page navigation creates the cinematic experience where switching tabs feels like a camera dollying through a film studio. This is the highest-impact feature for immersive feel.

Output: CameraTransitionManager that watches route changes and triggers Spline camera state transitions. Framer Motion page transitions simplified when 3D is active to avoid visual competition.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-3d-experience/07-RESEARCH.md
@.planning/phases/07-3d-experience/07-CONTEXT.md
@.planning/phases/07-3d-experience/07-02-SUMMARY.md
@.planning/phases/05-animation-layer/05-02-SUMMARY.md

@src/components/layout/AppShell.tsx
@src/components/animation/PageTransition.tsx
@src/stores/scene3dStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CameraTransitionManager and camera state mapping</name>
  <files>
    src/components/3d/CameraTransitionManager.tsx
    src/stores/scene3dStore.ts
  </files>
  <action>
    1. Update `src/stores/scene3dStore.ts`:
       - Add `currentCameraState: string` to state (default: 'home-view')
       - Add `setCameraState(state: string)` action
       - Add `triggerCameraTransition(targetState: string)` action:
         - If `splineApp` is null, return (3D not loaded)
         - Try to find camera: `splineApp.findObjectByName('Camera')`
         - If found, call `camera.transition({ to: targetState, duration: 0.4, easing: 'EASE_IN_OUT' })` (400ms ≈ 350ms page transition)
         - Wrap in try/catch — if camera states don't exist in the scene, log warning and continue
         - Update `currentCameraState` to targetState
       - Note: The `transition()` API on SPEObject takes `TransitionParams: { to: string, from?: string, duration: number, delay?: number, easing?: string }`

    2. Create `src/components/3d/CameraTransitionManager.tsx`:
       - This is a renderless component (returns null) — it watches route changes and triggers camera transitions
       - Import `useLocation` from 'react-router'
       - Import `useScene3dStore` from '@/stores/scene3dStore'
       - Define route-to-camera-state mapping:
         ```typescript
         const ROUTE_CAMERA_MAP: Record<string, string> = {
           '/':           'home-view',
           '/discover':   'discover-view',
           '/trending':   'trending-view',
           '/dinner-time': 'dinner-view',
           '/free-movies': 'free-view',
         };
         ```
       - In useEffect watching `[location.pathname]`:
         - Look up camera state from ROUTE_CAMERA_MAP
         - If found and different from currentCameraState, call `triggerCameraTransition(targetState)`
         - If route not in map (e.g., unknown route), default to 'home-view'
       - The component does NOT manage Framer Motion — that stays in AppShell
       - Export default for potential lazy loading (though it's tiny)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - Console logs show camera transition attempts when navigating between tabs (even if .splinecode doesn't have camera states yet)
  </verify>
  <done>
    CameraTransitionManager watches react-router location changes and triggers Spline camera state transitions via the scene3dStore. Route-to-camera-state mapping covers all 5 app routes. Transition duration is 400ms with EASE_IN_OUT easing. Errors for missing camera states are caught gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 3D-aware page transition variants and wire into AppShell</name>
  <files>
    src/components/animation/PageTransition.tsx
    src/components/layout/AppShell.tsx
  </files>
  <action>
    1. Update `src/components/animation/PageTransition.tsx`:
       - Keep existing `pageVariants` and `pageTransition` unchanged (used for fallback-2d)
       - Add new `pageVariants3D` variant set for when 3D camera handles the spatial transition:
         ```typescript
         export const pageVariants3D: Variants = {
           initial: { opacity: 0 },
           animate: { opacity: 1 },
           exit: { opacity: 0 },
         };
         export const pageTransition3D: Transition = {
           duration: 0.3,
           ease: 'easeInOut',
         };
         ```
         These are simpler fade-only transitions — the 3D camera movement provides the spatial feedback, so the content just fades in/out without competing slide/scale transforms.
       - Duration 0.3s is slightly faster than camera's 0.4s — content fades in while camera is still settling, creating a layered cinematic feel.

    2. Update `src/components/layout/AppShell.tsx`:
       - Import `CameraTransitionManager` from `@/components/3d/CameraTransitionManager`
       - Import `pageVariants3D` and `pageTransition3D` from PageTransition module
       - Read `capability` and `sceneLoaded` from scene3dStore
       - Determine if 3D transitions are active: `const use3DTransitions = (capability === 'full-3d' || capability === 'reduced-3d') && sceneLoaded`
       - Select variants based on 3D state:
         ```tsx
         const activeVariants = use3DTransitions ? pageVariants3D : pageVariants;
         const activeTransition = use3DTransitions ? pageTransition3D : pageTransition;
         ```
       - Apply to the motion.main element:
         ```tsx
         <motion.main
           key={location.pathname}
           variants={activeVariants}
           initial="initial"
           animate="animate"
           exit="exit"
           transition={activeTransition}
           ...
         >
         ```
       - Render CameraTransitionManager when 3D is active:
         ```tsx
         {use3DTransitions && <CameraTransitionManager />}
         ```
         Place this inside the AppShell div but outside AnimatePresence (it watches routes globally, not per-page).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - When 3D is active: page transitions are fade-only (no slide/scale), camera movement provides spatial transition
    - When 3D is not active (fallback-2d): original pageVariants with slide+scale+fade still work
    - CameraTransitionManager only renders when 3D scene is loaded
  </verify>
  <done>
    AppShell dynamically selects between 3D-aware (fade-only) and standard (fade+slide+scale) page transition variants based on 3D capability and scene load state. CameraTransitionManager triggers Spline camera transitions on route change. The two systems (Spline camera + Framer Motion content) work in concert — camera provides spatial movement, content fades smoothly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Navigating between tabs triggers camera transition attempts (console logs)
4. Page content transitions are simplified (fade-only) when 3D is active
5. Standard page transitions still work when 3D is not available
6. No visual glitch or double-transition when switching tabs rapidly
</verification>

<success_criteria>
- Route changes trigger Spline camera state transitions matching the route-to-camera mapping
- Camera transitions use 400ms EASE_IN_OUT to match app timing
- Content transitions simplify to fade-only when 3D camera provides spatial movement
- Standard Framer Motion transitions remain intact for fallback-2d users
- CameraTransitionManager only activates when 3D scene is loaded and capable
- Missing camera states in the Spline scene don't crash the app
</success_criteria>

<output>
After completion, create `.planning/phases/07-3d-experience/07-04-SUMMARY.md`
</output>
