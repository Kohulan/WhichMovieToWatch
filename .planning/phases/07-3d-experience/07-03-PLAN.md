---
phase: 07-3d-experience
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - src/hooks/useSplineTheme.ts
  - src/hooks/useDeviceOrientation.ts
  - src/components/3d/GyroscopeProvider.tsx
  - src/components/3d/SplineScene.tsx
autonomous: true
requirements: [3DXP-02, 3DXP-05]

must_haves:
  truths:
    - "3D scene lighting automatically adapts when user switches theme preset (warm-orange, gold, clean-white)"
    - "3D scene atmosphere shifts between noir (dark mode) and bright studio (light mode)"
    - "Mobile users on reduced-3d or full-3d capable devices see a tasteful permission prompt for gyroscope access (fallback-2d devices do not mount GyroscopeProvider since it is nested inside SplineScene)"
    - "Gyroscope parallax works on mobile when permission is granted"
    - "Denied gyroscope permission falls back to touch-drag or static scene gracefully"
    - "iOS DeviceOrientationEvent.requestPermission is handled correctly from user gesture"
  artifacts:
    - path: "src/hooks/useSplineTheme.ts"
      provides: "Subscribes to themeStore and pushes variables to Spline scene"
      exports: ["useSplineTheme"]
    - path: "src/hooks/useDeviceOrientation.ts"
      provides: "Device orientation data with iOS permission handling"
      exports: ["useDeviceOrientation"]
    - path: "src/components/3d/GyroscopeProvider.tsx"
      provides: "Permission prompt UI and gyroscope data provider"
      exports: ["GyroscopeProvider"]
  key_links:
    - from: "src/hooks/useSplineTheme.ts"
      to: "src/stores/themeStore.ts"
      via: "subscribes to preset and mode changes"
      pattern: "useThemeStore"
    - from: "src/hooks/useSplineTheme.ts"
      to: "src/stores/scene3dStore.ts"
      via: "reads splineApp to call setVariable"
      pattern: "setVariable"
    - from: "src/components/3d/SplineScene.tsx"
      to: "src/hooks/useSplineTheme.ts"
      via: "calls useSplineTheme to sync theme"
      pattern: "useSplineTheme"
    - from: "src/components/3d/SplineScene.tsx"
      to: "src/components/3d/GyroscopeProvider.tsx"
      via: "renders GyroscopeProvider as child — only mounts when SplineScene mounts (full-3d/reduced-3d)"
      pattern: "GyroscopeProvider"
---

<objective>
Implement theme-to-3D synchronization via Spline variables and mobile gyroscope parallax with iOS permission handling.

Purpose: The 3D scene must feel integrated with the app's theme system — lighting color shifts when the user changes presets, and the atmosphere transforms between dark noir and bright studio on mode toggle. Mobile gyroscope adds a premium immersive touch where the scene responds to device tilt.

Output: useSplineTheme hook syncing all 6 theme variants to Spline variables, useDeviceOrientation hook with iOS permission flow, GyroscopeProvider with tasteful permission prompt UI. Note: GyroscopeProvider is nested inside SplineScene and therefore only mounts on devices with full-3d or reduced-3d capability — fallback-2d devices never see the gyroscope prompt because they never mount SplineScene.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-3d-experience/07-RESEARCH.md
@.planning/phases/07-3d-experience/07-CONTEXT.md
@.planning/phases/07-3d-experience/07-02-SUMMARY.md

@src/stores/themeStore.ts
@src/stores/scene3dStore.ts
@src/components/3d/SplineScene.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSplineTheme hook and integrate into SplineScene</name>
  <files>
    src/hooks/useSplineTheme.ts
    src/components/3d/SplineScene.tsx
  </files>
  <action>
    1. Create `src/hooks/useSplineTheme.ts`:
       - Subscribe to `useThemeStore` for `preset` and `mode`
       - Subscribe to `useScene3dStore` for `splineApp`
       - Define theme-to-Spline variable mapping:
         ```typescript
         const PRESET_LIGHTING: Record<ColorPreset, { hue: number; saturation: number }> = {
           'warm-orange': { hue: 38, saturation: 0.22 },
           'gold':        { hue: 80, saturation: 0.14 },
           'clean-white': { hue: 250, saturation: 0.003 },
         };
         const MODE_LIGHTING: Record<ThemeMode, { intensity: number; isDarkMode: boolean }> = {
           'dark':  { intensity: 0.7, isDarkMode: true },
           'light': { intensity: 1.0, isDarkMode: false },
         };
         ```
       - In a `useEffect` watching `[preset, mode, splineApp]`:
         - If `splineApp` is null, return early
         - Call `splineApp.setVariable('lightingHue', presetValues.hue)`
         - Call `splineApp.setVariable('lightingSaturation', presetValues.saturation)`
         - Call `splineApp.setVariable('lightingIntensity', modeValues.intensity)`
         - Call `splineApp.setVariable('isDarkMode', modeValues.isDarkMode)`
         - Wrap each call in try/catch — variables may not exist if the .splinecode scene wasn't designed with them yet. Log warnings but don't crash.
       - Export the hook. It has no return value — it's a side-effect hook.

    2. Update `src/components/3d/SplineScene.tsx`:
       - Import and call `useSplineTheme()` inside the component
       - This ensures theme syncing starts as soon as the scene loads and splineApp is set in the store
       - The hook is called unconditionally (React rules of hooks) but its effect only runs when splineApp is non-null
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - When switching theme presets (via RotaryDial), the console shows setVariable calls being made (add temporary console.log for dev testing)
    - No errors thrown if .splinecode doesn't have the expected variables
  </verify>
  <done>
    useSplineTheme reactively pushes preset lighting (hue, saturation) and mode lighting (intensity, isDarkMode) to the Spline scene whenever the user changes theme preset or mode. Errors for missing variables are caught gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useDeviceOrientation hook and GyroscopeProvider permission UI</name>
  <files>
    src/hooks/useDeviceOrientation.ts
    src/components/3d/GyroscopeProvider.tsx
    src/components/3d/SplineScene.tsx
  </files>
  <action>
    1. Create `src/hooks/useDeviceOrientation.ts`:
       - Export type `OrientationData = { alpha: number | null; beta: number | null; gamma: number | null }`
       - Export type `PermissionState = 'prompt' | 'granted' | 'denied' | 'unsupported'`
       - State: `orientation: OrientationData`, `permissionState: PermissionState`
       - On mount, check:
         - If `typeof DeviceOrientationEvent === 'undefined'` -> 'unsupported'
         - If `'requestPermission' in DeviceOrientationEvent` (iOS 13+) -> 'prompt' (need user gesture)
         - Else (Android, non-iOS) -> 'granted' (auto-available), start listening immediately
       - Expose `requestPermission()` async function:
         - Calls `(DeviceOrientationEvent as any).requestPermission()` (TypeScript doesn't have this in lib.dom)
         - If result is 'granted', start listening, set permissionState='granted', cache in localStorage ('wmtw-gyro-granted')
         - If result is 'denied', set permissionState='denied'
       - Listener: `window.addEventListener('deviceorientation', handler)`
         - Extract alpha, beta, gamma from event
         - Normalize beta (-180..180) and gamma (-90..90) to -1..1 range for parallax input
       - Cleanup: remove event listener on unmount
       - On mount, check localStorage 'wmtw-gyro-granted': if true AND on iOS, still need to call requestPermission from a gesture (iOS doesn't remember between sessions unless from a button tap). So cached value is used to auto-show the permission button, not to auto-grant.
       - Return `{ orientation, permissionState, requestPermission, isAvailable: permissionState !== 'unsupported' }`

    2. Create `src/components/3d/GyroscopeProvider.tsx`:
       - Uses `useDeviceOrientation` hook
       - Only renders on mobile (check `navigator.maxTouchPoints > 0` or media query)
       - IMPORTANT: This component is nested inside SplineScene.tsx, so it only mounts when the device has full-3d or reduced-3d capability. Fallback-2d devices never see this prompt. This is intentional — gyroscope parallax only makes sense when the 3D scene is actually rendering.
       - When `permissionState === 'prompt'` and device is mobile:
         - Render a small, tasteful floating button/card in the bottom-right corner (above TabBar):
           - Text: "Enable immersive tilt" with a Smartphone icon from lucide-react
           - Clay-styled (ClayCard-like) for design consistency
           - onClick calls `requestPermission()`
           - Dismiss X button that sets local state to hide and caches dismissal in localStorage ('wmtw-gyro-dismissed')
           - Auto-dismiss after 8 seconds if not interacted with
       - When `permissionState === 'granted'`: render nothing (gyroscope data flows via the hook)
       - When `permissionState === 'denied'` or `'unsupported'`: render nothing
       - Export the component

    3. Update `src/components/3d/SplineScene.tsx`:
       - Import `GyroscopeProvider` and render it as a child/sibling inside SplineScene
       - Import `useDeviceOrientation` and use the orientation data
       - On mobile with granted gyroscope:
         - The Spline runtime may handle gyroscope natively. If not, use the orientation data to simulate mouse-like input by calling `splineApp.emitEvent('mouseMove', ...)` with orientation-derived coordinates (research notes Spline tracks mouse globally)
         - Alternative approach: Apply a CSS transform to the Spline canvas container based on orientation data (rotateX/rotateY matching the parallax fallback pattern). This is simpler and works regardless of Spline's built-in behavior.
         - Use the simpler CSS transform approach: `transform: perspective(1000px) rotateX(${betaNorm * 3}deg) rotateY(${gammaNorm * 3}deg)` on the Spline container. This creates visible parallax depth from device tilt.
       - Wrap in `useSpring` from Framer Motion for smooth easing (stiffness: 50, damping: 20)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - On desktop: no gyroscope prompt appears, theme switching updates Spline variables
    - On mobile (simulated via DevTools): gyroscope prompt appears only if device has full-3d or reduced-3d capability
    - iOS permission flow handled without crashes (test in Safari if available)
    - On fallback-2d devices: no gyroscope prompt ever appears (SplineScene not mounted)
  </verify>
  <done>
    useSplineTheme syncs all 6 theme variants (3 presets x 2 modes) to Spline lighting variables. useDeviceOrientation handles iOS permission flow and provides normalized orientation data. GyroscopeProvider shows a tasteful one-time prompt on mobile devices with 3D capability (full-3d/reduced-3d only — fallback-2d devices never mount SplineScene so never see the prompt). Gyroscope data drives CSS perspective rotation on the Spline container for parallax depth on mobile.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Theme preset changes trigger Spline variable updates (verify via console logs)
4. Dark/light mode toggle changes scene atmosphere variables
5. Mobile gyroscope prompt appears only on devices with full-3d or reduced-3d capability
6. Gyroscope permission denied/unsupported falls back gracefully (no errors, no prompt)
7. Fallback-2d devices never see gyroscope prompt (SplineScene not mounted)
</verification>

<success_criteria>
- Theme preset changes (warm-orange/gold/clean-white) push correct lighting variables to Spline
- Dark/light mode toggle changes isDarkMode and lightingIntensity variables
- Mobile users on full-3d or reduced-3d capable devices see a tasteful permission prompt for gyroscope access
- Fallback-2d devices never see the gyroscope prompt
- Granted gyroscope creates parallax depth effect on the 3D scene
- All error cases handled gracefully (missing variables, denied permission, unsupported devices)
</success_criteria>

<output>
After completion, create `.planning/phases/07-3d-experience/07-03-SUMMARY.md`
</output>
