---
phase: 07-3d-experience
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - public/3d-models/scene.splinecode
  - src/components/3d/SplineHero.tsx
  - src/components/3d/SplineScene.tsx
  - src/components/layout/AppShell.tsx
  - src/stores/scene3dStore.ts
autonomous: true
requirements: [3DXP-01, 3DXP-04, 3DXP-06]
user_setup:
  - service: spline
    why: "3D scene design requires Spline editor (spline.design) to create the cinematic studio scene with props, camera states, and variables"
    dashboard_config:
      - task: "Design cinematic studio scene with film equipment props, camera states, and lighting variables per 07-RESEARCH.md specifications"
        location: "Spline editor (app.spline.design) — create new project, model props, configure states/variables, export as .splinecode"
      - task: "Export scene as .splinecode file and save to public/3d-models/scene.splinecode"
        location: "Spline editor — File > Export > Code (.splinecode)"

must_haves:
  truths:
    - "3D Spline scene renders as a fixed background layer, fully visible on HomePage and faded on feature pages"
    - "Scene loads progressively after splash screen without blocking LCP"
    - "Scene fades in smoothly over gradient blobs with opacity transition"
    - "No layout shift (CLS) when 3D canvas appears"
    - "Scene renders film equipment props (reel, clapperboard, camera, chair, spotlights)"
    - "Floating movie posters are visible in the atmospheric haze"
    - "Desktop mouse movement creates subtle parallax depth effect"
  artifacts:
    - path: "src/components/3d/SplineHero.tsx"
      provides: "Default-exported component rendering SplineScene, entry point for lazy loading from AppShell"
      exports: ["default"]
    - path: "src/components/3d/SplineScene.tsx"
      provides: "Core Spline component with onLoad, mouse parallax, fixed sizing"
      exports: ["SplineScene"]
    - path: "public/3d-models/scene.splinecode"
      provides: "Self-hosted Spline scene file"
  key_links:
    - from: "src/components/layout/AppShell.tsx"
      to: "src/components/3d/SplineHero.tsx"
      via: "React.lazy dynamic import inside the route-aware opacity wrapper div from Plan 07-01"
      pattern: "LazySplineHero"
    - from: "src/components/3d/SplineScene.tsx"
      to: "src/stores/scene3dStore.ts"
      via: "setSplineApp on scene load"
      pattern: "setSplineApp"
---

<objective>
Build the SplineHero and SplineScene components that load and render the Spline 3D scene inside the route-aware opacity wrapper established by Plan 07-01, with progressive loading after splash, opacity fade-in, and CLS-free canvas insertion.

Purpose: This is the core 3D deliverable. The Spline scene renders the abstract cinematic studio with film equipment props behind the clay UI, creating the immersive atmospheric backdrop that distinguishes this app. The scene renders globally (needed for camera transitions in Plan 07-04) inside the opacity wrapper from 07-01, so it is fully visible on HomePage and faded on feature pages where poster backdrops dominate.

Output: Working 3D scene visible as a background layer — prominent on HomePage, subtle on feature pages — progressively loaded, with mouse parallax on desktop. Placeholder .splinecode file if user hasn't designed the scene yet.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-3d-experience/07-RESEARCH.md
@.planning/phases/07-3d-experience/07-CONTEXT.md
@.planning/phases/07-3d-experience/07-01-SUMMARY.md

@src/components/layout/AppShell.tsx
@src/stores/scene3dStore.ts
@src/hooks/use3DCapability.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SplineScene core component and SplineHero lazy wrapper</name>
  <files>
    src/components/3d/SplineScene.tsx
    src/components/3d/SplineHero.tsx
    public/3d-models/scene.splinecode
  </files>
  <action>
    1. Create directory `public/3d-models/` if it doesn't exist.

    2. For the `.splinecode` file: The user needs to design and export the Spline scene using the Spline editor. If the scene file does not exist yet, create a placeholder approach:
       - SplineScene should accept a `sceneUrl` prop with a default pointing to `${import.meta.env.BASE_URL}3d-models/scene.splinecode`
       - Also accept a fallback Spline cloud URL as an alternative (e.g., a simple demo scene for development)
       - If the local file fails to load, log a warning and set scene3dStore.setSceneLoaded(false) gracefully

    3. Create `src/components/3d/SplineScene.tsx`:
       - Import `Spline` from `@splinetool/react-spline` (default import)
       - Import `Application` type from `@splinetool/runtime` for the spline app reference
       - Props: `sceneUrl?: string`, `className?: string`, `reduced?: boolean`
       - Wrap the `<Spline>` component in a fixed-size container div:
         - `position: fixed`, `inset: 0`, `width: 100vw`, `height: 100vh`
         - This prevents CLS — the container exists at full size before Spline loads
       - Handle `onLoad` callback:
         - Receives the `Application` instance (splineApp)
         - Call `scene3dStore.getState().setSplineApp(splineApp)` to store the reference
         - Call `scene3dStore.getState().setSceneLoaded(true)`
         - Set local `loaded` state to true to trigger opacity fade-in
       - Handle `onError`: Log error, call `scene3dStore.getState().setSceneLoaded(false)`
       - Opacity transition: container starts at `opacity: 0`, transitions to `opacity: 1` over 0.8s when loaded
       - Add `aria-hidden="true"` to the container — purely decorative
       - Add `pointerEvents: 'none'` to the container so clicks pass through to content below
       - Spline's default mouse tracking provides the parallax depth effect (built into the runtime)
       - BUT we need pointer events to reach the Spline canvas for mouse tracking — use a layered approach:
         - Outer div: `pointer-events-none` (clicks pass through)
         - Inner Spline component: leave default pointer events (Spline tracks mouse globally, not via click events)
         - Actually, Spline tracks mouse via `mousemove` on the document/window, so `pointer-events: none` on the canvas is fine for parallax. Verify this during testing.
       - For `reduced-3d` capability: accept a `reduced` prop. When true, Spline renders at lower resolution via `style={{ imageRendering: 'auto' }}` and the container can be smaller (e.g., 75% scale with CSS transform)
       - Export as `default` (required for React.lazy in AppShell)

    4. Create `src/components/3d/SplineHero.tsx`:
       - This is a thin default-exported wrapper around SplineScene
       - Directly imports and renders SplineScene (NOT React.lazy — AppShell handles the lazy boundary)
       - Accepts `reduced?: boolean` and passes it to SplineScene
       - Can add hero-specific logic in the future (camera state management, etc.)
       - `export default SplineHero` (required for `React.lazy` in AppShell)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds with `spline-vendor` chunk in output
    - SplineScene component correctly types the Spline onLoad callback with Application type
  </verify>
  <done>
    SplineScene renders a fixed fullscreen Spline canvas with opacity fade-in on load, CLS-free container, and splineApp reference stored in scene3dStore. SplineHero is a thin default-exported wrapper for lazy loading from AppShell.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate SplineHero into AppShell's route-aware opacity wrapper</name>
  <files>
    src/components/layout/AppShell.tsx
    src/stores/scene3dStore.ts
  </files>
  <action>
    1. Update `src/stores/scene3dStore.ts` if needed:
       - Ensure `sceneLoaded` state and `setSceneLoaded` action exist
       - Add `sceneError: boolean` and `setSceneError(error: boolean)` for error handling

    2. Update `src/components/layout/AppShell.tsx`:
       - Add lazy import for SplineHero:
         ```typescript
         const LazySplineHero = lazy(() => import('@/components/3d/SplineHero'));
         ```
       - In the route-aware opacity wrapper div created in Plan 07-01 (the `<div>` with `transition-opacity` and `isHomePage ? 1 : 0.15`), add SplineHero alongside ParallaxFallback:
         ```tsx
         <div
           className="fixed inset-0 transition-opacity duration-500"
           style={{ opacity: isHomePage ? 1 : 0.15 }}
           aria-hidden="true"
         >
           {capability === 'fallback-2d' && <ParallaxFallback />}
           {(capability === 'full-3d' || capability === 'reduced-3d') && (
             <Suspense fallback={null}>
               <LazySplineHero reduced={capability === 'reduced-3d'} />
             </Suspense>
           )}
         </div>
         ```
       - The `Suspense fallback={null}` means gradient blobs show while Spline loads — seamless progressive enhancement
       - The Spline canvas sits inside the route-aware opacity wrapper, so it automatically:
         - Shows at full opacity on HomePage (hero experience per user decision)
         - Fades to 0.15 opacity on feature pages (poster backdrops dominate per user decision)
         - Stays mounted on all routes (needed for camera transitions in Plan 07-04)
       - Progressive load timing: Since Scene3DProvider already runs detection after splash, and AppShell reads capability from store, the SplineHero only mounts after capability is resolved. The Spline runtime + .splinecode then load asynchronously. This naturally achieves "load after splash, fade in when ready."
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds — spline-vendor chunk exists and is NOT loaded in the initial JS bundle
    - Dev server shows: splash -> app loads with gradient blobs -> 3D scene fades in (if .splinecode exists and GPU is capable) OR parallax fallback shows (if low GPU)
    - On HomePage: 3D scene is fully visible (opacity 1 from wrapper)
    - On feature pages (Trending, Discover, etc.): 3D scene fades to subtle 0.15 opacity, poster backdrops are visually dominant
    - No CLS when 3D canvas appears (it's position:fixed behind content)
    - Content remains fully interactive — pointer events pass through the 3D layer
  </verify>
  <done>
    AppShell lazily loads SplineHero inside the route-aware opacity wrapper for capable devices (full-3d/reduced-3d) or renders ParallaxFallback for fallback-2d. Spline runtime is code-split and loads progressively after splash. Scene is fully visible on HomePage, faded on feature pages. No CLS, no LCP blocking.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with separate spline-vendor chunk
2. `npx tsc --noEmit` passes
3. 3D scene renders as fixed background behind content on capable devices
4. ParallaxFallback renders on low-end devices
5. On HomePage: 3D/parallax layer at full opacity (hero experience)
6. On feature pages: 3D/parallax layer at 0.15 opacity (poster backdrops dominate)
7. No layout shift when switching between pages
8. Spline runtime is NOT in the initial bundle (verify via build output chunk sizes)
9. Scene fades in smoothly after loading
</verification>

<success_criteria>
- Spline scene renders as a fixed fullscreen background layer inside the route-aware opacity wrapper
- Scene is fully visible on HomePage, faded to 0.15 on feature pages per user decisions
- Scene loads progressively after splash without blocking LCP or causing CLS
- SplineHero is lazy-loaded — Spline runtime only fetched when capability permits
- splineApp reference stored in scene3dStore for theme sync and camera transitions
- reduced-3d capability renders at lower fidelity
- Content remains fully clickable/scrollable above the 3D layer
</success_criteria>

<output>
After completion, create `.planning/phases/07-3d-experience/07-02-SUMMARY.md`
</output>
