---
phase: 07-3d-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - src/hooks/useGpuTier.ts
  - src/hooks/use3DCapability.ts
  - src/stores/scene3dStore.ts
  - src/components/3d/Scene3DProvider.tsx
  - src/components/3d/ParallaxFallback.tsx
  - src/components/layout/AppShell.tsx
autonomous: true
requirements: [3DXP-05, 3DXP-07, PERF-01]

must_haves:
  truths:
    - "GPU tier is detected on app start and cached for the session"
    - "Low-end devices (tier 0-1) or prefers-reduced-motion users get 2D parallax fallback automatically"
    - "Desktop tier 2+ users are flagged for full 3D capability"
    - "Mobile tier 2 users are flagged for reduced 3D"
    - "2D parallax fallback displays layered CSS depth with mouse-tracking on desktop"
    - "Spline runtime is isolated in its own Vite vendor chunk (not in initial bundle)"
    - "AppShell renders 3D or fallback layer globally (needed for camera transitions) but controls opacity per route — fully visible on HomePage, faded on feature pages where poster backdrops take over"
  artifacts:
    - path: "src/hooks/useGpuTier.ts"
      provides: "GPU tier detection via detect-gpu, cached result"
      exports: ["useGpuTier"]
    - path: "src/hooks/use3DCapability.ts"
      provides: "Combined GPU + WebGL + reduced-motion capability check"
      exports: ["use3DCapability", "Capability"]
    - path: "src/stores/scene3dStore.ts"
      provides: "Zustand store for 3D state: capability, loading, spline app ref"
      exports: ["useScene3dStore"]
    - path: "src/components/3d/Scene3DProvider.tsx"
      provides: "Context provider that runs detection and sets scene3dStore"
      exports: ["Scene3DProvider"]
    - path: "src/components/3d/ParallaxFallback.tsx"
      provides: "2D CSS parallax with layered depth and mouse tracking"
      exports: ["ParallaxFallback"]
    - path: "vite.config.ts"
      provides: "spline-vendor manual chunk for code-splitting"
      contains: "spline-vendor"
  key_links:
    - from: "src/components/3d/Scene3DProvider.tsx"
      to: "src/stores/scene3dStore.ts"
      via: "useScene3dStore to set capability"
      pattern: "useScene3dStore"
    - from: "src/components/3d/Scene3DProvider.tsx"
      to: "src/hooks/use3DCapability.ts"
      via: "runs detection on mount"
      pattern: "use3DCapability"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/components/3d/ParallaxFallback.tsx"
      via: "conditional render based on capability, opacity controlled by route"
      pattern: "ParallaxFallback"
    - from: "src/components/layout/AppShell.tsx"
      to: "react-router"
      via: "useLocation to determine route-based opacity for 3D layer"
      pattern: "useLocation"
---

<objective>
Install detect-gpu, create GPU tier detection and 3D capability hooks, build a 2D CSS parallax fallback for low-end devices, and wire Scene3DProvider into AppShell as the background layer between gradient blobs and content — with route-aware opacity so the 3D layer is fully visible on HomePage and faded on feature pages.

Purpose: Establish the detection and fallback foundation that all subsequent 3D plans build on. Every user gets either 3D or a convincing parallax alternative. Spline runtime is code-split into its own chunk so it never appears in the initial bundle. The 3D/parallax layer renders globally (required for camera transitions in Plan 07-04) but uses opacity control to honor the "Hero scene on HomePage" decision — feature pages show their own poster backdrops with the 3D scene subdued behind them.

Output: Working 2D parallax background on AppShell for all users (3D scene plugs in during Plan 07-02), GPU detection infrastructure, scene3dStore, spline-vendor Vite chunk, route-aware opacity pattern.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-3d-experience/07-RESEARCH.md
@.planning/phases/07-3d-experience/07-CONTEXT.md

@src/components/layout/AppShell.tsx
@src/stores/themeStore.ts
@vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, create GPU detection hooks, scene3d store, and Vite config</name>
  <files>
    vite.config.ts
    src/hooks/useGpuTier.ts
    src/hooks/use3DCapability.ts
    src/stores/scene3dStore.ts
  </files>
  <action>
    1. Install packages: `npm install @splinetool/react-spline @splinetool/runtime detect-gpu`

    2. Update `vite.config.ts` — add spline-vendor chunk to `manualChunks`:
       ```
       if (id.includes('node_modules/@splinetool')) {
         return 'spline-vendor';
       }
       ```
       Also add detect-gpu to its own chunk or bundle with spline-vendor.

    3. Create `src/hooks/useGpuTier.ts`:
       - Import `getGPUTier` from `detect-gpu`
       - Use module-level cache (not React state) so detection runs once per session
       - Return `{ tier: number, isMobile: boolean, gpu: string | undefined, loading: boolean }`
       - Tier values from detect-gpu: 0 (no GPU), 1 (low), 2 (mid), 3 (high)
       - Run detection in useEffect on mount, store result in module variable
       - If already cached, return immediately without re-running

    4. Create `src/hooks/use3DCapability.ts`:
       - Import useGpuTier
       - Export type `Capability = 'full-3d' | 'reduced-3d' | 'fallback-2d'`
       - Logic:
         - If `window.matchMedia('(prefers-reduced-motion: reduce)').matches` -> 'fallback-2d'
         - Tier 0-1 -> 'fallback-2d'
         - Tier 2 + mobile -> 'reduced-3d'
         - Tier 2 + desktop, Tier 3 -> 'full-3d'
       - Also check WebGL support: try `document.createElement('canvas').getContext('webgl2')` or `'webgl'`, if both fail -> 'fallback-2d'
       - Return `{ capability: Capability, loading: boolean, tier: number }`

    5. Create `src/stores/scene3dStore.ts`:
       - Zustand store (no persist — runtime-only state)
       - State: `capability: Capability | null`, `loading: boolean`, `sceneLoaded: boolean`, `splineApp: any | null` (typed later when Spline is integrated)
       - Actions: `setCapability(cap)`, `setLoading(loading)`, `setSceneLoaded(loaded)`, `setSplineApp(app)`
       - Import Capability type from use3DCapability
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds and output includes a `spline-vendor` chunk in the build log
    - The detect-gpu package is in package.json dependencies
  </verify>
  <done>
    GPU detection hook returns tier 0-3 with mobile flag, 3D capability hook combines GPU + WebGL + reduced-motion into a single Capability enum, scene3dStore exists with capability/loading/splineApp state, Vite config isolates Spline into spline-vendor chunk.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ParallaxFallback component and Scene3DProvider</name>
  <files>
    src/components/3d/ParallaxFallback.tsx
    src/components/3d/Scene3DProvider.tsx
  </files>
  <action>
    1. Create `src/components/3d/ParallaxFallback.tsx`:
       - A fixed-position fullscreen div (inset-0) with CSS perspective parallax
       - Container div with `perspective: 1000px` and `transform-style: preserve-3d`
       - 4-5 child layers at different `translateZ` depths creating depth illusion:
         - Layer 1 (deepest, z=-200px): Large soft gradient circle (accent color at ~0.06 opacity), simulating deep ambient light
         - Layer 2 (z=-120px): Film reel silhouette SVG (simple circle+rectangles inline SVG), rotates slowly via CSS `film-reel-spin` class from animations.css
         - Layer 3 (z=-60px): Spotlight beam gradient (conical-gradient or radial), subtle sweep
         - Layer 4 (closest, z=-20px): Floating dust particles — 6-8 small dots with CSS animation (drift up slowly)
       - Mouse tracking via Framer Motion `useMotionValue` + `useTransform`:
         - Track mouse position normalized to -1..1 range
         - Apply subtle rotateX/rotateY (max 3-4 degrees) to the perspective container based on mouse position
         - Use `useSpring` for smooth easing (stiffness: 50, damping: 20)
       - The component accepts `className` prop for additional styling
       - Use theme CSS variables (--accent, --clay-base) for colors so it adapts to theme
       - Add `aria-hidden="true"` to the container — purely decorative
       - Wrap mouse tracking in a check: only track on desktop (no touch events), skip on mobile

    2. Create `src/components/3d/Scene3DProvider.tsx`:
       - Runs `use3DCapability` hook on mount
       - When capability resolves (loading=false), calls `useScene3dStore.getState().setCapability(capability)`
       - Renders children — this is a wrapper component, not a context provider (scene3dStore IS the context)
       - Example: `<Scene3DProvider>{children}</Scene3DProvider>` in App.tsx
       - This component does NOT render the parallax or 3D scene — AppShell handles that based on store state
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - ParallaxFallback renders layered depth with mouse-responsive rotation when viewed in browser
  </verify>
  <done>
    ParallaxFallback displays a 4-layer CSS perspective parallax with film-themed silhouettes and mouse-tracking rotation. Scene3DProvider runs GPU detection and writes capability to scene3dStore on mount.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire Scene3DProvider into App.tsx and render ParallaxFallback in AppShell with route-aware opacity</name>
  <files>
    src/App.tsx
    src/components/layout/AppShell.tsx
  </files>
  <action>
    1. Update `src/App.tsx`:
       - Import `Scene3DProvider` from `@/components/3d/Scene3DProvider`
       - Wrap the post-splash content (`<AppShell>` + `<TabBar>`) inside `<Scene3DProvider>`
       - Scene3DProvider goes INSIDE MotionProvider but OUTSIDE AppShell
       - This ensures GPU detection runs once when app loads (after splash)

    2. Update `src/components/layout/AppShell.tsx`:
       - Import `useScene3dStore` from `@/stores/scene3dStore`
       - Import `ParallaxFallback` from `@/components/3d/ParallaxFallback`
       - Import `useLocation` from `react-router`
       - Read capability from store: `const capability = useScene3dStore((s) => s.capability)`
       - Read current route: `const location = useLocation()`
       - Determine if current route is HomePage: `const isHomePage = location.pathname === '/'`
       - Between the gradient blobs div (z-0) and the main content (z-[1]), add a new layer at z-[0] (same z as blobs, but rendered after):
         ```tsx
         {/* 3D / Parallax background layer — renders globally for camera transitions,
             but opacity controlled per route: full on HomePage, faded on feature pages
             where poster backdrops take visual precedence.
             Per user decision: "Hero scene on HomePage — primary 3D experience"
             and "3D camera movement transitions between pages" */}
         <div
           className="fixed inset-0 transition-opacity duration-500"
           style={{ opacity: isHomePage ? 1 : 0.15 }}
           aria-hidden="true"
         >
           {capability === 'fallback-2d' && <ParallaxFallback />}
           {/* Future: capability === 'full-3d' || 'reduced-3d' renders SplineHero here (Plan 07-02) */}
         </div>
         ```
       - Key design rationale (document in code comment):
         - The 3D/parallax layer renders on ALL routes so that camera transitions (Plan 07-04) work — the Spline scene must stay mounted for camera state changes to execute
         - On HomePage (`/`), opacity is 1 — the 3D scene is the hero experience per user decision
         - On feature pages (`/trending`, `/dinner-time`, `/free-movies`, `/discover`), opacity drops to 0.15 — the existing movie poster backdrops take visual precedence per user decision, while the 3D scene remains subtly visible beneath and camera transitions still fire
         - `transition-opacity duration-500` ensures smooth opacity change when navigating between routes
       - While capability is null (still detecting), the wrapper div renders but has no visible content — gradient blobs are sufficient
       - Add a comment placeholder for SplineHero that Plan 07-02 will fill in
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - App launches, splash completes, parallax fallback appears behind content (if on low GPU or with prefers-reduced-motion)
    - On HomePage: parallax/3D layer is fully visible (opacity 1)
    - Navigate to Trending or Discover: parallax/3D layer fades to subtle background (opacity 0.15)
    - Navigate back to Home: parallax/3D layer fades back to full opacity
    - On capable devices, no parallax appears yet (capability is 'full-3d', SplineHero not yet built)
  </verify>
  <done>
    Scene3DProvider wraps post-splash app tree and runs GPU detection on mount. AppShell renders 3D/parallax layer globally (enabling future camera transitions) with route-aware opacity — fully visible on HomePage per user decision, faded on feature pages where poster backdrops take over. Gradient blobs remain as the base layer. The 3D placeholder is ready for SplineHero integration in Plan 07-02.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with spline-vendor chunk visible in output
2. `npx tsc --noEmit` passes with zero errors
3. Dev server at localhost:5173 shows the app with parallax fallback visible (test by temporarily forcing capability to 'fallback-2d')
4. On HomePage: 3D/parallax layer is at full opacity
5. On feature pages: 3D/parallax layer fades to 0.15 opacity, poster backdrops are visually dominant
6. No CLS — parallax layer is position:fixed, does not shift content
7. detect-gpu, @splinetool/react-spline, @splinetool/runtime all in package.json
</verification>

<success_criteria>
- GPU detection runs once per session and returns tier 0-3
- 3D capability hook correctly classifies devices into full-3d/reduced-3d/fallback-2d
- ParallaxFallback renders convincing CSS depth with mouse-responsive rotation
- Vite config code-splits Spline runtime into spline-vendor chunk
- AppShell renders 3D/parallax layer globally with route-aware opacity (full on HomePage, faded on feature pages)
- scene3dStore holds capability, loading, and splineApp state for subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/07-3d-experience/07-01-SUMMARY.md`
</output>
