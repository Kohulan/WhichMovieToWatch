---
phase: 02-data-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/preferencesStore.ts
  - src/stores/movieHistoryStore.ts
  - src/stores/regionStore.ts
  - src/stores/discoveryStore.ts
  - src/stores/searchStore.ts
  - src/hooks/useMigration.ts
autonomous: true
requirements:
  - DISC-05

must_haves:
  truths:
    - "Movie history store tracks shown, watched, loved, and not-interested movies with 2000-entry FIFO eviction on shownMovies"
    - "hasBeenShown checks union of shown + watched + notInterested lists to prevent repeat movies"
    - "Preferences store persists provider, genre, myServices, and taste profile to localStorage"
    - "Region store persists detected country and manual override with effectiveRegion getter"
    - "Legacy localStorage keys (watchedMovies, lovedMovies, etc.) are auto-migrated into Zustand stores and deleted"
    - "Discovery and search stores hold runtime state without persistence"
  artifacts:
    - path: "src/stores/movieHistoryStore.ts"
      provides: "Movie history with FIFO eviction and repeat prevention"
      exports: ["useMovieHistoryStore"]
    - path: "src/stores/preferencesStore.ts"
      provides: "User preferences with taste profile learning"
      exports: ["usePreferencesStore"]
    - path: "src/stores/regionStore.ts"
      provides: "Region detection and manual override state"
      exports: ["useRegionStore"]
    - path: "src/stores/discoveryStore.ts"
      provides: "Current discovery session state (non-persisted)"
      exports: ["useDiscoveryStore"]
    - path: "src/stores/searchStore.ts"
      provides: "Search query and results state (non-persisted)"
      exports: ["useSearchStore"]
    - path: "src/hooks/useMigration.ts"
      provides: "One-time migration of legacy localStorage into Zustand stores"
      exports: ["useMigration"]
  key_links:
    - from: "src/hooks/useMigration.ts"
      to: "src/stores/movieHistoryStore.ts"
      via: "getState().importLegacy() call"
      pattern: "useMovieHistoryStore\\.getState\\(\\)"
    - from: "src/hooks/useMigration.ts"
      to: "src/stores/preferencesStore.ts"
      via: "getState().importLegacy() call"
      pattern: "usePreferencesStore\\.getState\\(\\)"
    - from: "src/stores/movieHistoryStore.ts"
      to: "localStorage"
      via: "Zustand persist middleware with key wmtw-movie-history"
      pattern: "name:\\s*'wmtw-movie-history'"
---

<objective>
Create all 5 Zustand stores (3 persisted + 2 runtime) and the legacy localStorage migration hook.

Purpose: Stores are the reactive state backbone consumed by all hooks and future UI components. The movie history store directly implements DISC-05 (repeat prevention). Migration ensures existing users preserve their data when transitioning from the vanilla app.

Output: 5 Zustand store files in src/stores/, 1 migration hook in src/hooks/.
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-layer/02-RESEARCH.md
@src/stores/themeStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create persisted Zustand stores (preferences, movieHistory, region)</name>
  <files>
    src/stores/preferencesStore.ts
    src/stores/movieHistoryStore.ts
    src/stores/regionStore.ts
  </files>
  <action>
Follow the exact pattern established by `src/stores/themeStore.ts` (create + persist + createJSONStorage).

1. Create `src/stores/preferencesStore.ts`:
   - Interface `PreferencesState` with fields:
     - preferredProvider: string | null
     - preferredGenre: string | null
     - myServices: number[] (provider IDs user subscribes to)
     - tasteProfile: TasteProfile (import from @/types/preferences -- define inline if types not available yet: { genres: Record<number, number>, decades: Record<string, number>, directors: Record<number, number>, lastUpdated: number })
   - Actions:
     - setPreferredProvider(provider: string | null)
     - setPreferredGenre(genre: string | null)
     - setMyServices(services: number[])
     - toggleMyService(providerId: number) -- add if not present, remove if present
     - recordLove(genres: number[], decade: string, directorId?: number) -- increment genre weights by +1, decade by +1, director by +1, update lastUpdated
     - recordNotInterested(genres: number[], decade: string, directorId?: number) -- decrement genre weights by -1, decade by -0.5, director by -1, update lastUpdated
     - importLegacy(data: { preferredProvider: string | null, preferredGenre: string | null }) -- sets both fields
     - resetTasteProfile() -- resets to empty profile
   - Persist config: name 'wmtw-preferences', localStorage, version 1

2. Create `src/stores/movieHistoryStore.ts`:
   - MAX_SHOWN_HISTORY = 2000 (module-level const)
   - Interface `MovieHistoryState` with fields:
     - shownMovies: number[] (TMDB movie IDs)
     - watchedMovies: number[]
     - lovedMovies: number[]
     - notInterestedMovies: number[]
   - Actions:
     - hasBeenShown(movieId: number): boolean -- checks union of shownMovies + watchedMovies + notInterestedMovies using Set for O(1) lookup (create Set lazily from arrays)
     - trackShown(movieId: number) -- add to shownMovies if not present, apply FIFO eviction if length > MAX_SHOWN_HISTORY (slice from end, keeping newest)
     - markWatched(movieId: number) -- add to watchedMovies if not present
     - markLoved(movieId: number) -- add to lovedMovies if not present
     - markNotInterested(movieId: number) -- add to notInterestedMovies if not present
     - removeWatched(movieId: number) -- remove from watchedMovies
     - removeLoved(movieId: number) -- remove from lovedMovies
     - removeNotInterested(movieId: number) -- remove from notInterestedMovies
     - importLegacy(data: { shownMovies: number[], watchedMovies: number[], lovedMovies: number[], notInterestedMovies: number[] }) -- sets all arrays, applies FIFO cap on shownMovies
     - getExcludeSet(): Set<number> -- returns union of shownMovies + watchedMovies + notInterestedMovies as a Set (for efficient lookup during discovery)
   - Persist config: name 'wmtw-movie-history', localStorage, version 1
   - Use partialize to exclude derived methods from serialization

3. Create `src/stores/regionStore.ts`:
   - Interface `RegionState` with fields:
     - detectedCountry: string (default 'DE')
     - manualOverride: string | null (default null)
     - lastDetected: number (default 0)
   - Actions:
     - effectiveRegion(): string -- returns manualOverride || detectedCountry
     - setDetectedCountry(country: string) -- sets detectedCountry + lastDetected = Date.now()
     - setManualOverride(country: string | null) -- sets manualOverride
     - needsDetection(): boolean -- returns lastDetected === 0 or Date.now() - lastDetected > 24h
   - Persist config: name 'wmtw-region', localStorage, version 1
   - Use partialize to only persist detectedCountry, manualOverride, lastDetected (not action functions)
  </action>
  <verify>
Run `npx tsc --noEmit` -- should compile with no errors.
Verify all 3 stores exist and export their hooks.
Verify persist names are unique: grep for "name:" in all store files to check no collisions with 'theme-preferences'.
  </verify>
  <done>
Three persisted stores exist, each with unique localStorage keys, following the themeStore pattern. movieHistoryStore caps shownMovies at 2000 with FIFO eviction. preferencesStore tracks taste profile with love/not-interested signals.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create runtime stores and legacy migration hook</name>
  <files>
    src/stores/discoveryStore.ts
    src/stores/searchStore.ts
    src/hooks/useMigration.ts
  </files>
  <action>
1. Create `src/stores/discoveryStore.ts` (NOT persisted):
   - Interface `DiscoveryState` with fields:
     - currentMovie: TMDBMovieDetails | null (import type from @/types/movie, or use `any` with TODO comment if types not available yet)
     - isLoading: boolean
     - error: string | null
     - relaxationStep: number (0-4, tracks current filter relaxation level)
     - filters: { genreId: string | null, providerId: number | null, minRating: number, minVoteCount: number }
   - Actions:
     - setCurrentMovie(movie: TMDBMovieDetails | null)
     - setLoading(loading: boolean)
     - setError(error: string | null)
     - setRelaxationStep(step: number)
     - setFilters(filters: Partial of DiscoveryState['filters'])
     - reset() -- resets all fields to defaults (movie null, loading false, error null, step 0)
   - Default filters: genreId null, providerId null, minRating 6.0, minVoteCount 500
   - Use plain `create` without persist middleware

2. Create `src/stores/searchStore.ts` (NOT persisted):
   - Interface `SearchState` with fields:
     - query: string
     - results: TMDBMovie[] (import type)
     - totalResults: number
     - currentPage: number
     - totalPages: number
     - isLoading: boolean
     - error: string | null
     - sortBy: string (default 'popularity.desc')
   - Actions:
     - setQuery(query: string)
     - setResults(results: TMDBMovie[], totalResults: number, totalPages: number, currentPage: number)
     - appendResults(results: TMDBMovie[], currentPage: number) -- for pagination
     - setSortBy(sortBy: string)
     - setLoading(loading: boolean)
     - setError(error: string | null)
     - reset() -- clears query, results, resets to defaults

3. Create `src/hooks/useMigration.ts`:
   - Define OLD_KEYS array: 'watchedMovies', 'lovedMovies', 'notInterestedMovies', 'shownMovies', 'preferredProvider', 'preferredGenre', 'theme'
   - MIGRATION_FLAG = 'wmtw-v2-migrated'
   - Helper function `safeParseJSON<T>(raw: string | null, fallback: T): T` that wraps JSON.parse in try/catch
   - Export `useMigration()` hook:
     - useEffect with empty deps (runs once on mount)
     - Check if localStorage.getItem(MIGRATION_FLAG) exists -- if so, return early
     - Read all old keys using safeParseJSON with appropriate fallbacks ([] for arrays, null for strings)
     - Import into movieHistoryStore via `useMovieHistoryStore.getState().importLegacy({...})`
     - Import into preferencesStore via `usePreferencesStore.getState().importLegacy({...})`
     - Note: theme migration is NOT needed -- Phase 1's themeStore already uses 'theme-preferences' key, which is different from the old 'theme' key. Leave the old 'theme' key alone (it's for the vanilla app fallback).
     - Delete all OLD_KEYS from localStorage (except 'theme' -- keep for backwards compat with vanilla app)
     - Set MIGRATION_FLAG to String(Date.now())
     - Log 'Legacy data migrated successfully' to console

IMPORTANT: Migration runs SYNCHRONOUSLY within useEffect. This is fine because localStorage reads are synchronous, and Zustand's getState().importLegacy() calls are also synchronous. The persist middleware will auto-save to localStorage after the state update.

IMPORTANT: Do NOT run migration before Zustand hydrates. Using useEffect (which fires after render) ensures Zustand has already hydrated from localStorage. The importLegacy calls will overwrite the hydrated empty state with legacy data, and persist will save the merged result.
  </action>
  <verify>
Run `npx tsc --noEmit` -- should compile with no errors.
Verify runtime stores do NOT use persist middleware: `grep "persist" src/stores/discoveryStore.ts src/stores/searchStore.ts` should return nothing.
Verify migration hook imports both stores: `grep "useMovieHistoryStore\|usePreferencesStore" src/hooks/useMigration.ts`.
  </verify>
  <done>
Two runtime stores exist without persistence. Migration hook reads legacy localStorage keys, imports into Zustand stores, and cleans up old keys. Migration is idempotent (checks flag before running).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. 5 store files exist in src/stores/ (themeStore.ts + 4 new + discoveryStore + searchStore = 6 total)
3. 3 persisted stores have unique localStorage keys: 'wmtw-preferences', 'wmtw-movie-history', 'wmtw-region'
4. 2 runtime stores use plain `create` without persist
5. movieHistoryStore.trackShown applies FIFO eviction at 2000 entries
6. movieHistoryStore.hasBeenShown checks union of shown + watched + notInterested
7. Migration hook exists and imports from both persisted stores
</verification>

<success_criteria>
- All 5 new Zustand stores compile and export their hooks
- Persisted stores follow themeStore pattern exactly (create + persist + createJSONStorage + localStorage)
- movieHistoryStore implements DISC-05: tracks shown movies, prevents repeats, caps at 2000
- preferencesStore tracks taste profile with love/not-interested signals
- regionStore defaults to 'DE' with manual override support
- Migration hook auto-detects and imports legacy vanilla app data
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-layer/02-02-SUMMARY.md`
</output>
