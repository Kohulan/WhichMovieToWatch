---
phase: 02-data-layer
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/genre-map.ts
  - src/lib/country-names.ts
  - src/lib/provider-registry.ts
  - src/lib/taste-engine.ts
autonomous: true
requirements:
  - DISC-05
  - DISC-06

must_haves:
  truths:
    - "Genre map provides bidirectional lookup between TMDB genre IDs and genre names"
    - "Country names map provides ISO 3166-1 alpha-2 code to country name lookup for 200+ countries"
    - "Provider registry maps known providers to deep link URL patterns and free-provider detection"
    - "Taste engine scores movies based on accumulated love/not-interested signals across genres, decades, and directors"
  artifacts:
    - path: "src/lib/genre-map.ts"
      provides: "TMDB genre ID to name mapping and reverse lookup"
      exports: ["GENRE_MAP", "getGenreName", "getGenreId"]
    - path: "src/lib/country-names.ts"
      provides: "ISO country code to display name mapping"
      exports: ["COUNTRY_NAMES", "getCountryName"]
    - path: "src/lib/provider-registry.ts"
      provides: "Provider metadata, deep link patterns, free provider detection"
      exports: ["getProviderDeepLink", "isFreeProvider", "PROVIDER_LOGOS_BASE"]
    - path: "src/lib/taste-engine.ts"
      provides: "Taste profile scoring algorithm for discovery weighting"
      exports: ["scoreTasteMatch"]
  key_links:
    - from: "src/lib/taste-engine.ts"
      to: "src/types/preferences.ts"
      via: "TasteProfile type import"
      pattern: "import.*TasteProfile"
    - from: "src/lib/provider-registry.ts"
      to: "src/types/provider.ts"
      via: "ProviderInfo type import"
      pattern: "import.*Provider"
---

<objective>
Create utility modules for genre mapping, country names, provider deep links, and the taste scoring algorithm.

Purpose: These pure utility functions are consumed by API services (genre filtering, region handling), hooks (taste-based discovery weighting), and future UI (provider deep links, free badges). Separating them into src/lib/ keeps services and hooks focused on their concerns.

Output: 4 utility modules in src/lib/ with zero React dependencies (pure functions and data).
</objective>

<execution_context>
@/Users/kohulanrajan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kohulanrajan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-layer/02-RESEARCH.md
@scripts/utils.js
@scripts/preferences.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create genre map and country names modules</name>
  <files>
    src/lib/genre-map.ts
    src/lib/country-names.ts
  </files>
  <action>
1. Create `src/lib/genre-map.ts`:
   - Export `GENRE_MAP: Record<number, string>` with all TMDB movie genre IDs:
     28: 'Action', 12: 'Adventure', 16: 'Animation', 35: 'Comedy', 80: 'Crime',
     99: 'Documentary', 18: 'Drama', 10751: 'Family', 14: 'Fantasy', 36: 'History',
     27: 'Horror', 10402: 'Music', 9648: 'Mystery', 10749: 'Romance',
     878: 'Science Fiction', 10770: 'TV Movie', 53: 'Thriller', 10752: 'War', 37: 'Western'
   - Export `getGenreName(id: number): string | undefined` -- simple lookup
   - Export `getGenreId(name: string): number | undefined` -- reverse lookup (case-insensitive)
   - Export `getAllGenres(): Array<{ id: number; name: string }>` -- returns sorted array of all genres

2. Create `src/lib/country-names.ts`:
   - Export `COUNTRY_NAMES: Record<string, string>` -- port the existing `countryNames` object from `scripts/utils.js` (it has 200+ entries). Include at minimum all countries commonly available in TMDB's watch provider regions:
     US, GB, DE, FR, ES, IT, NL, BE, AT, CH, SE, NO, DK, FI, PT, IE, AU, NZ, CA, MX, BR, AR, CL, CO, IN, JP, KR, TH, PH, ID, MY, SG, HK, TW, ZA, EG, TR, PL, CZ, HU, RO, GR, IL, AE, SA, RU, UA
   - Port ALL entries from the existing `countryNames` object in scripts/utils.js -- do not truncate
   - Export `getCountryName(code: string): string` -- returns country name or the code itself as fallback
   - Export `getAllCountryCodes(): string[]` -- returns sorted array of all codes

Both modules are pure data + helper functions. No React, no side effects.
  </action>
  <verify>
Run `npx tsc --noEmit` -- should compile with no errors.
Verify genre map has 19 entries: `grep -c ":" src/lib/genre-map.ts` (should be > 19 accounting for type annotations).
Verify country names has 200+ entries: `wc -l src/lib/country-names.ts` (should be substantial).
  </verify>
  <done>
Genre map provides all 19 TMDB movie genres with bidirectional lookup. Country names map provides 200+ ISO code to name mappings ported from the vanilla app.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create provider registry and taste engine</name>
  <files>
    src/lib/provider-registry.ts
    src/lib/taste-engine.ts
  </files>
  <action>
1. Create `src/lib/provider-registry.ts`:
   - Export `PROVIDER_LOGOS_BASE = 'https://image.tmdb.org/t/p/original'` (for constructing full logo URLs from TMDB logo_path)
   - Export `getProviderLogoUrl(logoPath: string): string` -- returns PROVIDER_LOGOS_BASE + logoPath
   - Define `KNOWN_FREE_PROVIDERS: Set<number>` with provider IDs known to be free-with-ads:
     Tubi (73), Pluto TV (300), Crackle (12), Plex (538), Freevee (613), Roku Channel (207), Peacock Free (386), Xumo (344), Kanopy (191), Hoopla (212)
     (These IDs are from TMDB's provider list -- verify against actual TMDB data in runtime, but these are the common ones)
   - Export `isFreeProvider(providerId: number): boolean` -- checks KNOWN_FREE_PROVIDERS
   - Define `DEEP_LINK_PATTERNS: Record<number, string>` for known providers:
     Netflix (8): 'https://www.netflix.com/title/{tmdb_external_id}'
     Amazon Prime (9/119): 'https://www.amazon.com/dp/{tmdb_external_id}'
     Disney+ (337): 'https://www.disneyplus.com/movies/{slug}'
     Apple TV+ (350): 'https://tv.apple.com/movie/{slug}'
     For others without known patterns, return the TMDB link as fallback
   - Export `getProviderDeepLink(providerId: number, tmdbLink: string): string`:
     - For known providers with patterns, return the pattern URL
     - For unknown providers, return the tmdbLink (TMDB's JustWatch-powered link)
     - Note: Deep links are best-effort. TMDB's tmdb_link is always the reliable fallback. The pattern-based links may not always resolve correctly, so tmdbLink is the safe default for most providers.
   - Actually, simplify: since deep link patterns are unreliable across regions and change frequently, just use the TMDB-provided link for all providers. Export getProviderDeepLink that simply returns tmdbLink. Keep isFreeProvider as the main value-add of this module.

2. Create `src/lib/taste-engine.ts`:
   - Import TasteProfile type (from @/types/preferences or define inline)
   - Export `scoreTasteMatch(profile: TasteProfile, movie: { genre_ids?: number[]; genres?: Array<{ id: number }>; release_date?: string; credits?: { crew?: Array<{ id: number; job: string }> } }): number`:
     - Extract genre IDs from movie (prefer genre_ids, fallback to genres[].id)
     - Extract decade from release_date (e.g., "2024-01-15" -> "2020s")
     - Extract director ID from credits.crew where job === 'Director' (first match)
     - Calculate score:
       - Genre score: sum of profile.genres[genreId] for each movie genre, divided by number of genres (normalized)
       - Decade score: profile.decades[decade] || 0
       - Director score: profile.directors[directorId] || 0 (weighted 2x because director is a strong signal)
       - Total = genreScore + decadeScore + directorScore * 2
     - Return the total score (can be negative if user dislikes the movie's characteristics)
   - Export `getDecadeFromYear(year: number): string` -- e.g., 2024 -> "2020s", 1995 -> "1990s"
   - Export `getDecadeFromReleaseDate(releaseDate: string): string` -- parses "YYYY-MM-DD" and calls getDecadeFromYear

Both modules are pure functions. No React, no side effects, no external dependencies.
  </action>
  <verify>
Run `npx tsc --noEmit` -- should compile with no errors.
Verify provider registry exports: `grep "export" src/lib/provider-registry.ts`.
Verify taste engine exports: `grep "export" src/lib/taste-engine.ts`.
  </verify>
  <done>
Provider registry identifies free providers and constructs logo URLs. Taste engine scores movies against user's accumulated preference profile across genres, decades, and directors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. 4 utility modules exist in src/lib/
3. Genre map contains all 19 TMDB movie genres
4. Country names map has 200+ entries ported from vanilla app
5. Provider registry correctly identifies known free providers
6. Taste engine returns numeric score (positive=liked characteristics, negative=disliked)
7. No React imports in any lib/ file (pure utility modules)
</verification>

<success_criteria>
- All 4 utility modules compile and export specified functions
- Genre map is complete (all 19 TMDB genres)
- Country names are comprehensive (200+ countries from vanilla app)
- Provider registry flags free-with-ads services
- Taste engine scores movies using multi-signal profile (genres + decades + directors)
- All modules are pure functions with zero React dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-layer/02-03-SUMMARY.md`
</output>
